
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Setup a Kubernetes Cluster &#8212; epics-containers 4.2.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=d0ae6d56"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/setup_k8s';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://epics-containers.github.io/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '4.2.0';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="icon" href="../_static/k8s-epics2.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Create a New Kubernetes Beamline" href="setup_k8s_new_beamline.html" />
    <link rel="prev" title="Working with Support Modules" href="support_module.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="4.2.0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/k8s-epics2.ico" class="logo__image only-light" alt=""/>
    <img src="../_static/k8s-epics2.ico" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">epics-containers</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Tutorials Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup_workstation.html">Set up a Developer Workstation</a></li>
<li class="toctree-l1"><a class="reference internal" href="launch_example.html">Launch A Simulation Beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_beamline.html">Create a Beamline Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_example.html">Deploying and Managing IOC Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_ioc.html">Create an IOC Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_container.html">Developer Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_container2.html">Developer Containers Part 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc_changes1.html">Changing the IOC Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc_changes2.html">Changing a Generic IOC</a></li>
<li class="toctree-l1"><a class="reference internal" href="generic_ioc.html">Create a Generic IOC</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug_generic_ioc.html">Debugging Generic IOC Builds</a></li>
<li class="toctree-l1"><a class="reference internal" href="support_module.html">Working with Support Modules</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Setup a Kubernetes Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup_k8s_new_beamline.html">Create a New Kubernetes Beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="add_k8s_ioc.html">Add an IOC to the Kubernetes Beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="rtems_setup.html">RTEMS - Creating a File Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="rtems_ioc.html">RTEMS - Deploying an Example IOC</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../tutorials.html" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Setup a Kubernetes Cluster</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="setup-a-kubernetes-cluster">
<span id="setup-kubernetes"></span><h1>Setup a Kubernetes Cluster<a class="headerlink" href="#setup-a-kubernetes-cluster" title="Link to this heading">#</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>DLS Users</strong>: DLS already has the test cluster <code class="docutils literal notranslate"><span class="pre">Pollux</span></code> which includes the test beamlines p45j, p38 and p99,  and the training beamlines p46 through to p49.</p>
<p>We are in the process of rolling out clusters for our production beamlines. To date (Aug 2024) we have clusters for: b01-1, b21, i03, i04, i13-1, i15-1, i18, i20-1, i22.</p>
<p>For this reason DLS users should skip this tutorial unless you have a spare linux machine with root access and an interest in how Clusters are created.</p>
</div>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>This is a very easy set of instructions for setting up an experimental single-node Kubernetes cluster, ready for a test deployment of EPICS IOCs.</p>
</section>
<section id="bring-your-own-cluster">
<h2>Bring Your Own Cluster<a class="headerlink" href="#bring-your-own-cluster" title="Link to this heading">#</a></h2>
<p>If you already have a Kubernetes cluster then you can skip this section.
and go straight to the next tutorial.</p>
<p>IMPORTANT: you will require appropriate permissions on the cluster to work with epics-containers. In particular you will need to be able to create pods that run with network=host. This is to allow Channel Access traffic to be routed to and from the IOCs. You will also need to be able to create a namespace and a service account, although you could use an existing namespace and service account as long as it has network=host capability. The alternative to running with network=host is to run a ca-gateway in the cluster and expose the PVs to the IOCs via the gateway.</p>
<p>Cloud based K8S offerings may not be appropriate because of the Channel Access
routing requirement.</p>
</section>
<section id="platform-choice">
<h2>Platform Choice<a class="headerlink" href="#platform-choice" title="Link to this heading">#</a></h2>
<p>These instructions have been tested on Ubuntu 22.04; however, any modern Linux distribution that is supported by k3s and running on a modern x86 machine should also work.</p>
<p>Note that K3S provides a good uninstaller that will clean up your system if you decide to back out. So there is no harm in trying it out.</p>
<p>If you prefer to investigate other implementations there are also these easy to install, lightweight Kubernetes implementations:</p>
<blockquote>
<div><ul class="simple">
<li><p>kind <a class="reference external" href="https://kind.sigs.k8s.io/docs/user/quick-start/">https://kind.sigs.k8s.io/docs/user/quick-start/</a></p></li>
<li><p>microk8s <a class="reference external" href="https://microk8s.io/">https://microk8s.io/</a></p></li>
<li><p>minikube <a class="reference external" href="https://minikube.sigs.k8s.io/docs/start/">https://minikube.sigs.k8s.io/docs/start/</a></p></li>
</ul>
</div></blockquote>
<p>For k3s documentation see <a class="reference external" href="https://k3s.io/">https://k3s.io/</a>.</p>
</section>
<section id="installation-steps">
<h2>Installation Steps<a class="headerlink" href="#installation-steps" title="Link to this heading">#</a></h2>
<p>These instructions work with a single machine or with a server running k3s and a workstation running the client CLI.</p>
<section id="install-k3s-lightweight-kubernetes">
<h3>Install K3S lightweight Kubernetes<a class="headerlink" href="#install-k3s-lightweight-kubernetes" title="Link to this heading">#</a></h3>
<p>Execute this command on your server to set up the cluster master (aka K3S Server node):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">sfL</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">get</span><span class="o">.</span><span class="n">k3s</span><span class="o">.</span><span class="n">io</span> <span class="o">|</span> <span class="n">sh</span> <span class="o">-</span>
</pre></div>
</div>
</section>
<section id="install-kubectl">
<span id="id1"></span><h3>Install kubectl<a class="headerlink" href="#install-kubectl" title="Link to this heading">#</a></h3>
<p>Kubectl is the command line tool for interacting with Kubernetes Clusters.</p>
<p>Note that by default, the kubectl that comes with k3s reads its config from /etc/rancher/k3s/k3s.yaml and would therefore be run with sudo. By using $KUBECONFIG we conform to the standard version that reads its config from $HOME/.kube/config.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>echo &#39;export KUBECONFIG=$HOME/.kube/config&#39; &gt;&gt; $HOME/.bashrc
source $HOME/.bashrc
</pre></div>
</div>
<p>(replace <code class="docutils literal notranslate"><span class="pre">$HOME/.bashrc</span></code> with <code class="docutils literal notranslate"><span class="pre">$HOME/.zshrc</span></code> for zsh user)</p>
<p>Then log out and back in for this to be set for all shells.</p>
</section>
<section id="configure-kubectl">
<h3>Configure kubectl<a class="headerlink" href="#configure-kubectl" title="Link to this heading">#</a></h3>
<p>kubectl uses a default configuration file  <strong>$HOME/.kube/config</strong> to connect to the cluster. Here we will copy the configuration file from the server to the workstation.</p>
<p>If you have one machine only then copy the k3s kubectl configuration into your home directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>~/.kube
sudo<span class="w"> </span>cp<span class="w">  </span>/etc/rancher/k3s/k3s.yaml<span class="w"> </span>~/.kube/config
sudo<span class="w"> </span>chown<span class="w"> </span>&lt;YOUR<span class="w"> </span>USER&gt;<span class="w"> </span>~/.kube/config
</pre></div>
</div>
<p>If you have a separate server then from the server machine copy over the k3s kubectl configuration:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>~/.kube
sudo<span class="w"> </span>scp<span class="w">  </span>/etc/rancher/k3s/k3s.yaml<span class="w"> </span>&lt;YOUR_ACCOUNT&gt;@&lt;YOUR_WORKSTATION&gt;:.kube/config
</pre></div>
</div>
<p>If you do have separate workstation then edit the file .kube/config replacing 127.0.0.1 with your server’s IP Address. For a single machine the file is left as is.</p>
</section>
<section id="install-helm">
<h3>Install helm<a class="headerlink" href="#install-helm" title="Link to this heading">#</a></h3>
<p>Helm is a package manager for Kubernetes. It is used to install and manage software on Kubernetes clusters.</p>
<p>See https://helm.sh/docs/intro/install/.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-fsSL<span class="w"> </span>-o<span class="w"> </span>get_helm.sh<span class="w"> </span>https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod<span class="w"> </span><span class="m">700</span><span class="w"> </span>get_helm.sh
./get_helm.sh
</pre></div>
</div>
</section>
<section id="test-your-installation">
<h3>Test your installation<a class="headerlink" href="#test-your-installation" title="Link to this heading">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
</pre></div>
</div>
<p>This should return the name of your single worker node (i.e. your server or workstation name) e.g.:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>node
NAME<span class="w">    </span>STATUS<span class="w">   </span>ROLES<span class="w">                  </span>AGE<span class="w">   </span>VERSION
ecws1<span class="w">   </span>Ready<span class="w">    </span>control-plane,master<span class="w">   </span>25m<span class="w">   </span>v1.30.4+k3s1
<span class="o">(</span>venv<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="create-an-epics-iocs-namespace-and-context">
<h3>Create an epics IOCs namespace and context<a class="headerlink" href="#create-an-epics-iocs-namespace-and-context" title="Link to this heading">#</a></h3>
<p>For each beamline or EPICS domain there will be a kubernetes namespace. Namespaces allow
us to isolate sets of cluster resources from each other, epics-containers uses a namespace for each beamline or accelerator domain.</p>
<p>A context is a combination of a cluster, namespace, and user. It tells kubectl which cluster and namespace to use when communicating with the Kubernetes API.</p>
<p>Here we will create a namespace for our test beamline t03-beamline.</p>
<p>From the workstation INSIDE the devcontainer execute the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>t03-beamline
kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span>t03-beamline<span class="w"> </span>--namespace<span class="o">=</span>t03-beamline<span class="w"> </span>--user<span class="o">=</span>default<span class="w"> </span>--cluster<span class="o">=</span>default
kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>t03-beamline
</pre></div>
</div>
</section>
<section id="install-persistent-volume-support">
<h3>Install persistent volume support<a class="headerlink" href="#install-persistent-volume-support" title="Link to this heading">#</a></h3>
<p>As per <a class="reference external" href="https://docs.k3s.io/storage/">https://docs.k3s.io/storage/</a>, the “Longhorn” distributed block storage system can be set up in our cluster. This is done in order to get support for ReadWriteMany persistent volume claims, which is not supported by the out of the box “Local Path Provisioner”.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install dependancies</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>update<span class="p">;</span><span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>open-iscsi<span class="w"> </span>nfs-common<span class="w"> </span>jq

<span class="c1"># Set up longhorn</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/longhorn/longhorn/v1.7.0/deploy/longhorn.yaml

<span class="c1"># Monitor while Longhorn starts up</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--namespace<span class="w"> </span>longhorn-system<span class="w"> </span>--watch

<span class="c1"># Confirm ready</span>
kubectl<span class="w"> </span>get<span class="w"> </span>storageclass
</pre></div>
</div>
</section>
<section id="set-up-k8s-dashboard-optional">
<span id="k8s-dashboard"></span><h3>Set up k8s dashboard (Optional)<a class="headerlink" href="#set-up-k8s-dashboard-optional" title="Link to this heading">#</a></h3>
<p>The Kubernetes dashboard is a web-based Kubernetes user interface.
As per <a class="reference external" href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a> it can be installed into the cluster as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">repo</span> <span class="n">add</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">dashboard</span><span class="o">/</span>
<span class="n">helm</span> <span class="n">upgrade</span> <span class="o">--</span><span class="n">install</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span> <span class="o">--</span><span class="n">create</span><span class="o">-</span><span class="n">namespace</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span>
</pre></div>
</div>
<p>To access the gui through a browser on <code class="docutils literal notranslate"><span class="pre">https://localhost:8080/</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span> <span class="n">port</span><span class="o">-</span><span class="n">forward</span> <span class="n">svc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span><span class="o">-</span><span class="n">kong</span><span class="o">-</span><span class="n">proxy</span> <span class="mi">8080</span><span class="p">:</span><span class="mi">443</span>
</pre></div>
</div>
<p>To generate a bearer token in order to log in - first create a Service Account:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ServiceAccount</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">admin</span><span class="o">-</span><span class="n">user</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span>
<span class="n">EOF</span>
</pre></div>
</div>
<p>Then bind the Service Account to a role with suitable permissions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRoleBinding</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">admin</span><span class="o">-</span><span class="n">user</span>
<span class="n">roleRef</span><span class="p">:</span>
  <span class="n">apiGroup</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRole</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">cluster</span><span class="o">-</span><span class="n">admin</span>
<span class="n">subjects</span><span class="p">:</span>
<span class="o">-</span> <span class="n">kind</span><span class="p">:</span> <span class="n">ServiceAccount</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">admin</span><span class="o">-</span><span class="n">user</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span>
<span class="n">EOF</span>
</pre></div>
</div>
<p>Finally generate a short duration token that can be used to log in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span> <span class="n">create</span> <span class="n">token</span> <span class="n">admin</span><span class="o">-</span><span class="n">user</span>
</pre></div>
</div>
</section>
<section id="set-up-argo-cd">
<h3>Set up Argo CD<a class="headerlink" href="#set-up-argo-cd" title="Link to this heading">#</a></h3>
<p>Argo CD is a declarative, GitOps continuous delivery tool for Kubernetes. As per <a class="reference external" href="https://argo-cd.readthedocs.io/en/stable/">https://argo-cd.readthedocs.io/en/stable/</a> it can be installed into the cluster as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="n">namespace</span> <span class="n">argocd</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">n</span> <span class="n">argocd</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">argoproj</span><span class="o">/</span><span class="n">argo</span><span class="o">-</span><span class="n">cd</span><span class="o">/</span><span class="n">stable</span><span class="o">/</span><span class="n">manifests</span><span class="o">/</span><span class="n">install</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>To access the gui through a browser on <code class="docutils literal notranslate"><span class="pre">https://localhost:8080/</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">port</span><span class="o">-</span><span class="n">forward</span> <span class="n">svc</span><span class="o">/</span><span class="n">argocd</span><span class="o">-</span><span class="n">server</span> <span class="o">-</span><span class="n">n</span> <span class="n">argocd</span> <span class="mi">8080</span><span class="p">:</span><span class="mi">443</span>
</pre></div>
</div>
<p>The user is <code class="docutils literal notranslate"><span class="pre">admin</span></code> and the password can be retrived using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">argocd</span> <span class="n">get</span> <span class="n">secret</span> <span class="n">argocd</span><span class="o">-</span><span class="n">initial</span><span class="o">-</span><span class="n">admin</span><span class="o">-</span><span class="n">secret</span> <span class="o">-</span><span class="n">o</span> <span class="n">jsonpath</span><span class="o">=</span><span class="s2">&quot;{.data.password}&quot;</span> <span class="o">|</span> <span class="n">base64</span> <span class="o">--</span><span class="n">decode</span> <span class="p">;</span> <span class="n">echo</span>
</pre></div>
</div>
<p>To install the <code class="docutils literal notranslate"><span class="pre">argocd</span></code> cli tool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">sSL</span> <span class="o">-</span><span class="n">o</span> <span class="n">argocd</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">argoproj</span><span class="o">/</span><span class="n">argo</span><span class="o">-</span><span class="n">cd</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">argocd</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span>
<span class="n">sudo</span> <span class="n">install</span> <span class="o">-</span><span class="n">m</span> <span class="mi">555</span> <span class="n">argocd</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">argocd</span>
<span class="n">rm</span> <span class="n">argocd</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span>
</pre></div>
</div>
<p>Create a new argocd project from the command line, with permissions to deploy into your namespace:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">argocd</span> <span class="n">login</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">8080</span>
<span class="n">argocd</span> <span class="n">proj</span> <span class="n">create</span> <span class="n">t03</span> <span class="o">-</span><span class="n">d</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="p">,</span><span class="n">t03</span><span class="o">-</span><span class="n">beamline</span> <span class="o">-</span><span class="n">d</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="p">,</span><span class="n">argocd</span> <span class="o">-</span><span class="n">s</span> <span class="s2">&quot;*&quot;</span>
</pre></div>
</div>
<p>When deploying to the same cluster that Argo CD is running in the destination cluster is by default aliased as “in-cluster”.
Argocd Apps should be deployed into the argocd namespace.</p>
</section>
<section id="completed">
<h3>Completed<a class="headerlink" href="#completed" title="Link to this heading">#</a></h3>
<p>That’s it. You now have installed the necessary software to start experimenting with IOCs on Kubernetes.</p>
<p>To remove everything you have installed above and clean up the disk space
simply use this command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>k3s-uninstall.sh
</pre></div>
</div>
<p>If you are interested in looking at the k3s files see <strong>/var/lib/rancher/k3s/</strong>.</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="support_module.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Working with Support Modules</p>
      </div>
    </a>
    <a class="right-next"
       href="setup_k8s_new_beamline.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Create a New Kubernetes Beamline</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bring-your-own-cluster">Bring Your Own Cluster</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#platform-choice">Platform Choice</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installation-steps">Installation Steps</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-k3s-lightweight-kubernetes">Install K3S lightweight Kubernetes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-kubectl">Install kubectl</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-kubectl">Configure kubectl</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-helm">Install helm</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-your-installation">Test your installation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-an-epics-iocs-namespace-and-context">Create an epics IOCs namespace and context</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-persistent-volume-support">Install persistent volume support</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-k8s-dashboard-optional">Set up k8s dashboard (Optional)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-argo-cd">Set up Argo CD</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#completed">Completed</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/epics-containers/epics-containers.github.io/edit/4.2.0/docs/tutorials/setup_k8s.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorials/setup_k8s.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>