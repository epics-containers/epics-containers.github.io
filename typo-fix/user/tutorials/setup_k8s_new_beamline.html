
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Create a New Kubernetes Beamline &#8212; epics-containers.github.io 2023.11.2.dev57+g77e47d9 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=e48de194"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user/tutorials/setup_k8s_new_beamline';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.2';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://epics-containers.github.io/epics-containers.github.io/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'typo-fix';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../../_static/k8s-epics2.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="RTEMS - Creating a File Server" href="rtems_setup.html" />
    <link rel="prev" title="Setup a Kubernetes Server" href="setup_k8s.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/k8s-epics2.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../../_static/k8s-epics2.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">EPICS Containers</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../developer/index.html">
                        Developer Guide
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://github.com/epics-containers/epics-containers.github.io/releases">
                    Release Notes
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers.github.io" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../developer/index.html">
                        Developer Guide
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://github.com/epics-containers/epics-containers.github.io/releases">
                    Release Notes
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers.github.io" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Tutorials Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup_workstation.html">Set up a Developer Workstation</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_beamline.html">Create a Beamline Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_example.html">Deploying and Managing IOC Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_ioc.html">Create an IOC Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_container.html">Developer Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc_changes1.html">Changing the IOC Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc_changes2.html">Changing a Generic IOC</a></li>
<li class="toctree-l1"><a class="reference internal" href="generic_ioc.html">Create a Generic IOC</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug_generic_ioc.html">Debugging Generic IOC Builds</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_generic_ioc.html">Testing and Deploying a Generic IOC</a></li>
<li class="toctree-l1"><a class="reference internal" href="support_module.html">Working with Support Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup_k8s.html">Setup a Kubernetes Server</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Create a New Kubernetes Beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="rtems_setup.html">RTEMS - Creating a File Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="rtems_ioc.html">RTEMS - Deploying an Example IOC</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../how-to/phoebus.html">Viewing Operator Interfaces with Phoebus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/debug.html">Debug an IOC instance locally</a></li>

<li class="toctree-l1"><a class="reference internal" href="../how-to/contributing.html">Contributing to the project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/own_tools.html">Choose Your Developer Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/useful_k8s.html">Kubernetes Additional How To’s</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/ibek-support.html">Updating and Testing ibek-support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/builder2ibek.html">Builder2ibek Conversion Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/builder2ibek.support.html">Builder2ibek.support Conversion Tool</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../explanations/introduction.html">Essential Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/net_protocols.html">Channel Access and Other Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/kubernetes_cluster.html">Kubernetes Cluster Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/docs-structure.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/repositories.html">Source and Registry Locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/ioc-source.html">Dev Container vs Runtime Container</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../reference/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/configuration.html">Configuration for epics-containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/environment.html">The Environment Configuration File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/cli.html">Command Line Interface for IOC Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/ioc_helm_chart.html">IOC Helm Chart Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/k8s_resources.html">Kubernetes Resources in an IOC Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/vscode_settings.html">Recommended VSCode Settings</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Create a...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="create-a-new-kubernetes-beamline">
<span id="setup-k8s-beamline"></span><h1>Create a New Kubernetes Beamline<a class="headerlink" href="#create-a-new-kubernetes-beamline" title="Link to this heading">#</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is a first draft that has been tested against a DLS test beamline
only. I will remove this warning once it has been tested against:</p>
<ul class="simple">
<li><p>the k3s example cluster described in the previous tutorial</p></li>
<li><p>a real DLS beamline.</p></li>
</ul>
<p>TODO: would it be better to have a separate tutorial for each of these?</p>
</div>
<p>Up until now the tutorials have been deploying IOCs to the local docker or
podman instance on your workstation. In this tutorial we look into setting
up a Kubernetes cluster for a beamline and deploying a test IOC there.</p>
<p>The advantage of using Kubernetes is that it is a production grade container
orchestration system. It will manage the CPU, disk and memory available across
your cluster of nodes, scheduling your IOCs and other services accordingly.
It will also restart them if they fail and monitor their health.
It can provide centralised logging and monitoring
of all of your services including IOCs.</p>
<p>In this tutorial we will create a new beamline in the Kubernetes cluster.
Here we assume that the cluster is already setup and that there is
a namespace configured for use by the beamline. See the previous tutorial
for how to set one up if you do not have this already.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>DLS users: these instructions are for the BL46P beamline. This beamline
already exists at DLS, so you could just skip ahead to creating the
example IOC. You will need to ask the cloud team for permission on
cluster <code class="docutils literal notranslate"><span class="pre">pollux</span></code>, namespace <code class="docutils literal notranslate"><span class="pre">p46-iocs</span></code> to do this.
Go to this URL to request access:
<a class="reference external" href="https://jira.diamond.ac.uk/servicedesk/customer/portal/2/create/92">https://jira.diamond.ac.uk/servicedesk/customer/portal/2/create/92</a></p>
<p>HOWEVER, these instructions can be also used to setup any
new beamline at DLS - just substitute the beamline name where appropriate.
You will need to have a beamline cluster already created for the
beamline by the cloud team and have requested access via the URL above.</p>
</div>
<section id="create-a-new-beamline-repository">
<h2>Create a new beamline repository<a class="headerlink" href="#create-a-new-beamline-repository" title="Link to this heading">#</a></h2>
<p>To create a new beamline repository, use the template repository at
<a class="github reference external" href="https://github.com/epics-containers/blxxi-template">epics-containers/blxxi-template</a>. Click on the green
“Use this template” button to create a new repository. Name the repository
bl46p (or choose your own name and remember to substitute it in the rest of
this tutorial). Create this repository in your own GitHub account.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>DLS users: if this is real beamline then it needs to be
created in our internal GitLab registry at
<a class="reference external" href="https://gitlab.diamond.ac.uk/controls/containers/beamline">https://gitlab.diamond.ac.uk/controls/containers/beamline</a>.
For this purpose use the template description for <a class="reference external" href="https://github.com/epics-containers/bl38p?tab=readme-ov-file#how-to-create-a-new-beamline--accelerator-domain">bl38p</a>.</p>
<p>For test DLS beamlines these should still be created in github
as per the below instructions.</p>
</div>
<p>Clone the new repository to your local machine and change directory into it.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/YOUR_GITHUB_ACCOUNT/bl46p.git
<span class="nb">cd</span><span class="w"> </span>bl46p
</pre></div>
</div>
<p>Next make some changes to the repository to customise it for your beamline.
Cut and paste the following script to do so.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">BEAMLINE</span><span class="o">=</span>bl46p

<span class="c1"># update the readme</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Beamline repo for the beamline </span><span class="nv">$BEAMLINE</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>README.md

<span class="c1"># remove the sample IOC directory</span>
rm<span class="w"> </span>-r<span class="w"> </span>iocs/blxxi-ea-ioc-01
<span class="c1"># change the services setup scripts to use the new beamline name</span>
sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s/blxxi/</span><span class="nv">$BEAMLINE</span><span class="s2">/g&quot;</span><span class="w"> </span>services/*<span class="w"> </span>beamline-chart/values.yaml
</pre></div>
</div>
</section>
<section id="cluster-topologies">
<h2>Cluster Topologies<a class="headerlink" href="#cluster-topologies" title="Link to this heading">#</a></h2>
<p>There are two supported topologies for beamline clusters:</p>
<ul class="simple">
<li><p>shared cluster with multiple beamlines’ IOCs running in the same cluster</p></li>
<li><p>dedicated cluster with a single beamline’s IOCs running in the cluster</p></li>
</ul>
<p>If you are working with the single node k3s cluster set up in the previous
tutorial then this will be considered a dedicated cluster.</p>
<p>If you are creating a real DLS beamline or accelerator domain then this will
also be a dedicated cluster. You will need to make sure the cloud team has
created the cluster for the beamline and you have permissions to use it.</p>
<p>If you are working with one of the test beamlines at DLS then these are usually
shared topology and are set up as nodes on the Pollux cluster.</p>
<p>Other facilities are free to choose the topology that best suits their needs.</p>
<section id="shared-clusters">
<h3>Shared Clusters<a class="headerlink" href="#shared-clusters" title="Link to this heading">#</a></h3>
<p>In the shared cluster topology we would usually want IOCs to run on the
servers that are closest to the beamline. This is important for Channel Access
because it is a broadcast protocol and by default only works on a single
subnet.</p>
<p>To facilitate this we use <code class="docutils literal notranslate"><span class="pre">node</span> <span class="pre">affinity</span> <span class="pre">rules</span></code> to ensure that IOCs
run on the beamline’s specific nodes. <code class="docutils literal notranslate"><span class="pre">Node</span> <span class="pre">affinity</span></code> can look for a <code class="docutils literal notranslate"><span class="pre">label</span></code>
on the node to say that it belongs to a beamline.
We can also use <code class="docutils literal notranslate"><span class="pre">taints</span></code> to stop other pods from
running on our beamline nodes. A <code class="docutils literal notranslate"><span class="pre">taint</span></code> will stop pods from being scheduled
on a node unless the pod has a matching toleration.</p>
<p>For example the test beamline p46 at DLS has the following <code class="docutils literal notranslate"><span class="pre">taints</span></code> and
<code class="docutils literal notranslate"><span class="pre">labels</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Labels</span><span class="p">:</span>         <span class="n">beamline</span><span class="o">=</span><span class="n">bl46p</span>
                <span class="n">nodetype</span><span class="o">=</span><span class="n">test</span><span class="o">-</span><span class="n">rig</span>

<span class="n">Taints</span><span class="p">:</span>         <span class="n">beamline</span><span class="o">=</span><span class="n">bl46p</span><span class="p">:</span><span class="n">NoSchedule</span>
                <span class="n">nodetype</span><span class="o">=</span><span class="n">test</span><span class="o">-</span><span class="n">rig</span><span class="p">:</span><span class="n">NoSchedule</span>
</pre></div>
</div>
<p>If you are working with your facility cluster then, you are may not to
have permission to set up these labels and taints. In this case, your
administrator will need to do this for you. At DLS, you should expect that
this is already set up for you.</p>
<p>For an explanation of these K8S concepts see</p>
<ul class="simple">
<li><p><a class="reference external" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/">Taints and Tolerances</a></p></li>
<li><p><a class="reference external" href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity-beta-feature">Node Affinity</a></p></li>
</ul>
</section>
<section id="dedicated-clusters">
<h3>Dedicated Clusters<a class="headerlink" href="#dedicated-clusters" title="Link to this heading">#</a></h3>
<p>In the dedicated cluster topology we would usually want to let the IOCs
run on all of the worker nodes in the cluster. In this case the only thing
that is required is a namespace in which to run your IOCs.</p>
<p>By convention we use a namespace like <code class="docutils literal notranslate"><span class="pre">bl46p-iocs</span></code> for this purpose. This
namespace will need the appropriate permissions to allow the IOCs to run
with network host.</p>
</section>
</section>
<section id="environment-setup">
<h2>Environment Setup<a class="headerlink" href="#environment-setup" title="Link to this heading">#</a></h2>
<p>Every beamline repository has an <code class="docutils literal notranslate"><span class="pre">environment.sh</span></code> file used to configure
your shell so that the command line tools know which cluster to talk to.
Up to this point we have been using the local docker or podman instance,
but here we will configure it to use the beamline cluster.</p>
<p>For the detail of what goes into <code class="docutils literal notranslate"><span class="pre">environment.sh</span></code> see
<a class="reference internal" href="../reference/environment.html"><span class="doc">The Environment Configuration File</span></a>.</p>
<p>Now edit <code class="docutils literal notranslate"><span class="pre">environment.sh</span></code> make changes as follows:</p>
<section id="section-1">
<h3>Section 1<a class="headerlink" href="#section-1" title="Link to this heading">#</a></h3>
<p>Change this section to set the following variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">EC_REGISTRY_MAPPING</span><span class="o">=</span><span class="s1">&#39;github.com=ghcr.io&#39;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">EC_K8S_NAMESPACE</span><span class="o">=</span>p46-iocs
<span class="nb">export</span><span class="w"> </span><span class="nv">EC_DOMAIN_REPO</span><span class="o">=</span>git@github.com:YOUR_GITHUB_ACCOUNT/bl46p.git
</pre></div>
</div>
<p>This tells the <code class="docutils literal notranslate"><span class="pre">ec</span></code> command line tool to use the GitHub container registry
when it sees github projects, the name of the Kubernetes namespace to use and
the location of the beamline repository.</p>
</section>
<section id="section-2">
<h3>Section 2<a class="headerlink" href="#section-2" title="Link to this heading">#</a></h3>
<p>The script should also make sure that <code class="docutils literal notranslate"><span class="pre">ec</span></code> CLI is available and it is also
useful to set up command line completion up. The simplest way to do this is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="w"> </span>-e<span class="w"> </span><span class="c1"># exit on error</span>
<span class="nb">source</span><span class="w"> </span>&lt;<span class="o">(</span>ec<span class="w"> </span>--show-completion<span class="w"> </span><span class="si">${</span><span class="nv">SHELL</span><span class="si">}</span><span class="o">)</span>
</pre></div>
</div>
<p>For a review of how to set up the epics-containers-cli tool <code class="docutils literal notranslate"><span class="pre">ec</span></code> see
<a class="reference internal" href="setup_workstation.html#python-setup"><span class="std std-ref">Install Python</span></a> and <a class="reference internal" href="setup_workstation.html#ec"><span class="std std-ref">epics-containers-cli</span></a>.</p>
</section>
<section id="section-3">
<h3>Section 3<a class="headerlink" href="#section-3" title="Link to this heading">#</a></h3>
<p>This is where you make sure the cluster is contactable. For the k3s cluster
we set up the default <code class="docutils literal notranslate"><span class="pre">~/.kube/config</span></code> file to point to the local cluster.
So we can leave this section blank.</p>
<p>At DLS you would need to load a module to set up the environment for the
beamline cluster. For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>pollux<span class="w"> </span><span class="c1"># for all test beamlines</span>
module<span class="w"> </span>load<span class="w"> </span>k8s-i22<span class="w"> </span><span class="c1"># for the real beamline i22</span>
</pre></div>
</div>
<p>Once <code class="docutils literal notranslate"><span class="pre">environment.sh</span></code> is set up, source it to set up your shell.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>environment.sh
</pre></div>
</div>
<p>You are now ready to start talking to the cluster. You can verify this with
the following command that should list all the nodes on the cluster. You
will be asked for your credentials if required.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
</pre></div>
</div>
</section>
</section>
<section id="setting-up-the-beamline-helm-chart-defaults">
<h2>Setting up the Beamline Helm Chart Defaults<a class="headerlink" href="#setting-up-the-beamline-helm-chart-defaults" title="Link to this heading">#</a></h2>
<p>The beamline helm chart is used to deploy IOCs to the cluster. Each IOC instance
gets to override any of the settings available in the chart. This is done
in <code class="docutils literal notranslate"><span class="pre">iocs/&lt;iocname&gt;/values.yaml</span></code> for each IOC instance. However, all
settings except <code class="docutils literal notranslate"><span class="pre">image</span></code> have default values supplied at the beamline level.
For this reason most IOC instances only need supply the <code class="docutils literal notranslate"><span class="pre">image</span></code> setting
which specifies the Generic IOC container image to use.</p>
<p>Before making the first IOC instance we need to set up the beamline defaults.
These are all held in the file <code class="docutils literal notranslate"><span class="pre">beamline-chart/values.yaml</span></code>.</p>
<p>Open this file and make the following changes depending on your beamline
type.</p>
<section id="all-cluster-types">
<h3>All cluster types<a class="headerlink" href="#all-cluster-types" title="Link to this heading">#</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">beamline</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bl46p</span>
<span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">p46-iocs</span>
<span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># required for channel access access on the host</span>

<span class="nt">opisClaim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bl46p-opi-claim</span>
<span class="nt">runtimeClaim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bl46p-runtime-claim</span>
<span class="nt">autosaveClaim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bl46p-autosave-claim</span>
</pre></div>
</div>
</section>
<section id="k3s-single-server-cluster">
<h3>k3s single server cluster<a class="headerlink" href="#k3s-single-server-cluster" title="Link to this heading">#</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dataVolume</span><span class="p">:</span>
<span class="w">  </span><span class="nt">pvc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="c1"># point at a PVC created by kubernetes</span>
<span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/</span>
</pre></div>
</div>
</section>
<section id="dls-test-beamlines">
<h3>DLS test beamlines<a class="headerlink" href="#dls-test-beamlines" title="Link to this heading">#</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dataVolume</span><span class="p">:</span>
<span class="w">  </span><span class="nt">pvc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="c1"># point at local disk on the server</span>
<span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/exports/mybeamline</span>

<span class="c1"># extra tolerations for the training rigs</span>
<span class="nt">tolerations</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nodetype</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">operator</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Equal&quot;</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">training-rig</span>
<span class="w">    </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;NoSchedule&quot;</span>
</pre></div>
</div>
</section>
<section id="dls-real-beamlines">
<h3>DLS real beamlines<a class="headerlink" href="#dls-real-beamlines" title="Link to this heading">#</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dataVolume</span><span class="p">:</span>
<span class="w">  </span><span class="nt">pvc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="c1"># point at the shared filesystem data folder for the beamline</span>
<span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dls/p46/data</span>
</pre></div>
</div>
</section>
</section>
<section id="set-up-the-one-time-only-beamline-resources">
<h2>Set Up The One Time Only Beamline Resources<a class="headerlink" href="#set-up-the-one-time-only-beamline-resources" title="Link to this heading">#</a></h2>
<p>There are two scripts in the <code class="docutils literal notranslate"><span class="pre">services</span></code> directory that set up some initial
resources. You should run each of these in order:</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">services/install-pvcs.sh</span></code>: this sets up some persistent volume claims for</dt><dd><p>the beamline. PVCS are Kubernetes managed chunks of storage that can be
shared between pods if required. The 3 PVCS created here relate to the
<code class="docutils literal notranslate"><span class="pre">Claim</span></code> entries in the <code class="docutils literal notranslate"><span class="pre">beamline-chart/values.yaml</span></code> file. These are
places to store:
- autosave files
- runtime generated startup scripts and EPICS database files
- OPI screens (usually auto generated)</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">services/install-opi.sh</span></code>: this sets up an nginx web server for the</dt><dd><p>beamline. It serves the OPI screens from the <code class="docutils literal notranslate"><span class="pre">opisClaim</span></code> PVC. Each IOC
instance will place its OPI screens in a subdirectory of this PVC.
OPI clients like phoebus can then retrieve these files via HTTP.</p>
</dd>
</dl>
</li>
</ul>
</section>
<section id="create-a-test-ioc-to-deploy">
<h2>Create a Test IOC to Deploy<a class="headerlink" href="#create-a-test-ioc-to-deploy" title="Link to this heading">#</a></h2>
<p>TODO: WIP (but this looks just like it did in the first IOC deployment tutorial)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At DLS you can get to a Kubernetes Dashboard for your beamline via
a landing page <code class="docutils literal notranslate"><span class="pre">https://pollux.diamond.ac.uk</span></code> for test beamlines on
<code class="docutils literal notranslate"><span class="pre">Pollux</span></code> - remember to select the namespace <code class="docutils literal notranslate"><span class="pre">p46-iocs</span></code> for example.</p>
<p>For real beamlines dedicated clusters, you can find the landing page for example:
<code class="docutils literal notranslate"><span class="pre">https://k8s-i22.diamond.ac.uk/</span></code> for BL22I.
<code class="docutils literal notranslate"><span class="pre">https://k8s-b01-1.diamond.ac.uk/</span></code> for the 2nd branch of BL01B.</p>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="setup_k8s.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Setup a Kubernetes Server</p>
      </div>
    </a>
    <a class="right-next"
       href="rtems_setup.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">RTEMS - Creating a File Server</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-new-beamline-repository">Create a new beamline repository</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-topologies">Cluster Topologies</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shared-clusters">Shared Clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dedicated-clusters">Dedicated Clusters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#section-1">Section 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#section-2">Section 2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#section-3">Section 3</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-beamline-helm-chart-defaults">Setting up the Beamline Helm Chart Defaults</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#all-cluster-types">All cluster types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k3s-single-server-cluster">k3s single server cluster</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dls-test-beamlines">DLS test beamlines</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dls-real-beamlines">DLS real beamlines</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-the-one-time-only-beamline-resources">Set Up The One Time Only Beamline Resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-test-ioc-to-deploy">Create a Test IOC to Deploy</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/epics-containers/epics-containers.github.io/edit/typo-fix/docs/user/tutorials/setup_k8s_new_beamline.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/user/tutorials/setup_k8s_new_beamline.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>