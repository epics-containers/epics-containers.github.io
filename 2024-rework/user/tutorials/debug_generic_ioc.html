
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Debugging Generic IOC Builds &#8212; epics-containers.github.io 2023.11.2.dev37+ge3a3912 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=3e475678"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user/tutorials/debug_generic_ioc';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.2';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://epics-containers.github.io/epics-containers.github.io/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '2024-rework';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../../_static/k8s-epics2.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Testing and Deploying a Generic IOC" href="test_generic_ioc.html" />
    <link rel="prev" title="Create a Generic IOC" href="generic_ioc.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/k8s-epics2.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../../_static/k8s-epics2.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">EPICS Containers</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../developer/index.html">
                        Developer Guide
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://github.com/epics-containers/epics-containers.github.io/releases">
                    Release Notes
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers.github.io" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../developer/index.html">
                        Developer Guide
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://github.com/epics-containers/epics-containers.github.io/releases">
                    Release Notes
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers.github.io" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Tutorials Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup_workstation.html">Set up a Developer Workstation</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_beamline.html">Create a Beamline Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_example.html">Deploying and Managing IOC Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_ioc.html">Create an IOC Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_container.html">Developer Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc_changes1.html">Changing the IOC Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc_changes2.html">Changing a Generic IOC</a></li>
<li class="toctree-l1"><a class="reference internal" href="generic_ioc.html">Create a Generic IOC</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Debugging Generic IOC Builds</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_generic_ioc.html">Testing and Deploying a Generic IOC</a></li>
<li class="toctree-l1"><a class="reference internal" href="support_module.html">Working with Support Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup_k8s.html">Setup a Kubernetes Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup_k8s_new_beamline.html">Create a New Kubernetes Beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="rtems_setup.html">RTEMS - Creating a File Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="rtems_ioc.html">RTEMS - Deploying an Example IOC</a></li>
<li class="toctree-l1"><a class="reference internal" href="ibek.html">Defining IOC Instances using IBEK</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../how-to/phoebus.html">Viewing Operator Interfaces with Phoebus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/debug.html">Debug an IOC instance locally</a></li>

<li class="toctree-l1"><a class="reference internal" href="../how-to/contributing.html">Contributing to the project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/own_tools.html">Choose Your Developer Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/useful_k8s.html">Kubernetes Additional How To’s</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/ibek-support.html">Updating and Testing ibek-support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/builder2ibek.html">Builder2ibek Conversion Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/builder2ibek.support.html">Builder2ibek.support Conversion Tool</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../explanations/introduction.html">Essential Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/net_protocols.html">Channel Access and Other Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/kubernetes_cluster.html">Kubernetes Cluster Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/docs-structure.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/repositories.html">Source and Registry Locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/ioc-source.html">Dev Container vs Runtime Container</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../reference/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/configuration.html">Configuration for epics-containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/environment.html">The Environment Configuration File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/cli.html">Command Line Interface for IOC Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/ioc_helm_chart.html">IOC Helm Chart Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/k8s_resources.html">Kubernetes Resources in an IOC Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/vscode_settings.html">Recommended VSCode Settings</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Debugging...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="debugging-generic-ioc-builds">
<h1>Debugging Generic IOC Builds<a class="headerlink" href="#debugging-generic-ioc-builds" title="Link to this heading">#</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This tutorial is out of date and will be updated soon.</p>
</div>
<p>This tutorial is a continuation of <a class="reference internal" href="generic_ioc.html"><span class="doc">Create a Generic IOC</span></a>. Here we will look into
debugging failed builds and fix the issue we saw in the previous tutorial.</p>
<p>This also comes under the category of type 2. change from the list
at <a class="reference internal" href="dev_container.html#ioc-change-types"><span class="std std-ref">Types of Changes</span></a>.</p>
<p>There are two ways to debug a failed build:</p>
<ul class="simple">
<li><p>Keep changing the Dockerfile and rebuilding the container until the build
succeeds. This is the simplest approach and is often sufficient since our
Dockerfile design maximizes the use of the build cache.</p></li>
<li><p>Investigate the build failure by running a shell inside the
partially-built container and
using make. This is a good idea if you have to make fundamental changes
such as installing a new system package. System package install happens
at the start of the Dockerfile and would trigger a full rebuild when
changed.</p></li>
</ul>
<p>You already have the knowledge to apply the first approach. In this tutorial
we will look debugging the build from <em>inside</em> the container.</p>
<section id="investigate-the-build-failure">
<h2>Investigate the Build Failure<a class="headerlink" href="#investigate-the-build-failure" title="Link to this heading">#</a></h2>
<p>When a container build fails the container image is created up to the point
where the last successful Dockerfile command was run. This means that we can
investigate the build failure by running a shell in the container. <code class="docutils literal notranslate"><span class="pre">ec</span></code>
provides us with the following convenience command to do this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ec<span class="w"> </span>dev<span class="w"> </span>debug-last
</pre></div>
</div>
<p>Now we have a prompt inside the part-built container and can retry the failed
command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/workspaces/epics/support/adurl
make
</pre></div>
</div>
<p>You should see the same error again.</p>
<p>A really good way to investigate this kind of error is with <code class="docutils literal notranslate"><span class="pre">apt-file</span></code>
which is a command line tool for searching Debian packages. apt-file is
already installed in our devcontainer. So get another terminal open
with the <code class="docutils literal notranslate"><span class="pre">[E7]</span></code> prompt and run the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>apt-file<span class="w"> </span>search<span class="w"> </span>Magick++.h

<span class="w">    </span>graphicsmagick-libmagick-dev-compat:<span class="w"> </span>/usr/include/Magick++.h
<span class="w">    </span>libgraphicsmagick++1-dev:<span class="w"> </span>/usr/include/GraphicsMagick/Magick++.h
<span class="w">    </span>libmagick++-6-headers:<span class="w"> </span>/usr/include/ImageMagick-6/Magick++.h
</pre></div>
</div>
<p>The middle result looks most promising so we will install it (back <em>inside</em>
the Generic IOC container now):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>libgraphicsmagick++1-dev
</pre></div>
</div>
<p>The reason using apt-file outside of the Generic IOC works is because
the Generic IOC and the devcontainer are built upon the same version of
Ubuntu and have the same packages available.</p>
<p>If we try the build again now it will still fail. We need to tell the
AreaDetector build system where to find the new header file. This
is documented here <a class="reference external" href="https://areadetector.github.io/areaDetector/install_guide.html#edit-config-site-local-and-optionally-config-site-local-epics-host-arch">CONFIG_SITE.local</a>. The documentation says that we
need to set the variable <code class="docutils literal notranslate"><span class="pre">GRAPHICSMAGICK_INCLUDE</span></code> in
<code class="docutils literal notranslate"><span class="pre">CONFIG_SITE.linux-x86_64.Common</span></code>.
We can see from the <code class="docutils literal notranslate"><span class="pre">apt-file</span></code> output that the header file is in
<code class="docutils literal notranslate"><span class="pre">/usr/include/GraphicsMagick</span></code> which is not a default include path.
Therefore we need to edit this file inside our Generic IOC container:
<code class="docutils literal notranslate"><span class="pre">/workspaces/epics/support/adurl/configure/CONFIG_SITE.linux-x86_64.Common</span></code></p>
</section>
<section id="making-changes-inside-the-container">
<h2>Making Changes Inside the Container<a class="headerlink" href="#making-changes-inside-the-container" title="Link to this heading">#</a></h2>
<p>You will find that the container includes busybox tools and there is a
rudimentary version of <code class="docutils literal notranslate"><span class="pre">vi</span></code> installed. You could also install any editor
you like from the Ubuntu repositories.</p>
<p>HOWEVER, there is a much easier way …</p>
<p>When you launch containers with <code class="docutils literal notranslate"><span class="pre">ec</span></code> commands the <code class="docutils literal notranslate"><span class="pre">/workspaces</span></code> folder is
synchronized to a local folder ioc-XXX/workspaces and that is mounted into the
container. This means that you can edit files in the container using VSCode.
The mounted repos folder also ensures that any changes you make inside the
container are saved between invocations of the container.</p>
<p>See the image below to see how to navigate to
<code class="docutils literal notranslate"><span class="pre">CONFIG_SITE.linux-x86_64.Common</span></code>
in the <code class="docutils literal notranslate"><span class="pre">adurl</span></code> support module inside the ioc-adurl container.</p>
<figure class="align-default" id="id1">
<img alt="../../_images/repos_folder.png" src="../../_images/repos_folder.png" />
<figcaption>
<p><span class="caption-text">VSCode file explorer showing the mounted repos folder</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Using VSCode file explorer as pictured above, navigate to the file
<code class="docutils literal notranslate"><span class="pre">CONFIG_SITE.linux-x86_64.Common</span></code> and update the GRAPHICSMAGICK section to
look like this:</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">WITH_GRAPHICSMAGICK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>YES
<span class="nv">GRAPHICSMAGICK_EXTERNAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>YES
<span class="nv">GRAPHICSMAGICK_INCLUDE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/usr/include/GraphicsMagick
</pre></div>
</div>
<p>Now go back to the terminal and run <code class="docutils literal notranslate"><span class="pre">make</span></code> again. This time it should
succeed.</p>
</section>
<section id="applying-changes-made-inside-the-container">
<h2>Applying Changes Made Inside the Container<a class="headerlink" href="#applying-changes-made-inside-the-container" title="Link to this heading">#</a></h2>
<p>When you use the ‘inside the container’ approach to get the build working
you still need to apply the changes you made ‘outside’ so that invoking
container build will also succeed.</p>
<dl class="field-list simple">
<dt class="field-odd">TIP<span class="colon">:</span></dt>
<dd class="field-odd"><p>do NOT apply the below, the next heading supplies a better solution
for this specific case.</p>
</dd>
</dl>
<p>There are a few kinds of changes that need different approaches as follows:</p>
<dl class="field-list simple">
<dt class="field-odd">apt install<span class="colon">:</span></dt>
<dd class="field-odd"><p>We did an apt install of <code class="docutils literal notranslate"><span class="pre">libgraphicsmagick++1-dev</span></code>. Additional system
package installs like this need to be added to the <code class="docutils literal notranslate"><span class="pre">apt-get</span> <span class="pre">install</span></code>
command at the top of the Dockerfile.</p>
</dd>
<dt class="field-even">CONFIG_SITE<span class="colon">:</span></dt>
<dd class="field-even"><p>We edited <code class="docutils literal notranslate"><span class="pre">CONFIG_SITE.linux-x86_64.Common</span></code>. This file is not part of
the ADURL support module but was supplied by us from ibek-defs.</p>
</dd>
<dt class="field-odd">Patching<span class="colon">:</span></dt>
<dd class="field-odd"><p>This should be avoided, but occasionally it may be necessary to patch other
files in the support modules. This is just a variation of the CONFIG_SITE
case above. You can place whatever script code you like in the
<code class="docutils literal notranslate"><span class="pre">ioc-XXX/patch</span></code> folder.</p>
</dd>
<dt class="field-even">Support Module<span class="colon">:</span></dt>
<dd class="field-even"><p>Potentially we could have made changes to the ADUrl support module itself
because we found a bug or wanted to add a feature. In this case we would
push those changes back up to GitHub and get a release made so we
could use the new version in our Dockerfile, This would in turn mean A
change to the version number in the <code class="docutils literal notranslate"><span class="pre">modules.py</span> <span class="pre">install</span> <span class="pre">ADURL</span></code>
command. NOTE: the developer container we are using already holds clones
of all the support modules so we could make changes in place and push them
back.</p>
</dd>
</dl>
</section>
<section id="an-easier-fix-using-adsupport">
<h2>An Easier Fix Using ADSupport<a class="headerlink" href="#an-easier-fix-using-adsupport" title="Link to this heading">#</a></h2>
<p>Although we managed to fix the build by installing Graphics Magick, into the
container there is an easier solution that is specific to areaDetector. The
ADSupport module is capable of building most of the system dependencies that
areaDetector needs. This has proved to be very useful in making containers
because the curation of all of the compatible versions of these dependencies
has already been done.</p>
<p>So the error we saw was due to us telling ADUrl to look for an ‘internal’
version of Graphics Magick built by ADSupport. However, we did not tell
ADSupport to build Graphics Magick.</p>
<p>So the simple fix to this is to add the following line to the
<code class="docutils literal notranslate"><span class="pre">ioc-adurl/ibek-defs/adsupport/adsupport.sh</span></code> file:</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">WITH_GRAPHICSMAGICK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>YES
<span class="nv">GRAPHICSMAGICK_EXTERNAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>NO
</pre></div>
</div>
<p>Then rebuild the container:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ec<span class="w"> </span>dev<span class="w"> </span>build
</pre></div>
</div>
<p>Note that the build skips quickly over the support modules until it gets
to ADSupport. This is the build cache saving time.
However this build will STILL FAIL, it turns out that building Graphics Magick
does need one system library install.</p>
<p>The final fix is to add <code class="docutils literal notranslate"><span class="pre">libxext-dev</span></code> to the <code class="docutils literal notranslate"><span class="pre">apt-get</span> <span class="pre">install</span></code> command in
our Dockerfile. So that it looks like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>RUN<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>upgrade<span class="w"> </span>-y<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--no-install-recommends<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libboost-all-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libxext-dev
</pre></div>
</div>
<p>This is an example of a change that also requires a system package
install for the runtime version of the container. Locate the second
<code class="docutils literal notranslate"><span class="pre">apt-get</span> <span class="pre">install</span></code> command in the Dockerfile and add <code class="docutils literal notranslate"><span class="pre">libxext6</span></code> so
that it looks like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>RUN<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>upgrade<span class="w"> </span>-y<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>--no-install-recommends<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libxext6<span class="w"> </span><span class="se">\</span>
<span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*
</pre></div>
</div>
<p>You can remove the RTEMS specific runtime packages that came with ioc-template.
Note that the <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">/var/lib/apt/lists/</span></code> removes the apt cache and keeps
the runtime image size down.</p>
<p>This build should now succeed. Unfortunately it has to rebuild the entire
container from scratch because we changed the first command in the Dockerfile.</p>
</section>
<section id="wrapping-up">
<h2>Wrapping Up<a class="headerlink" href="#wrapping-up" title="Link to this heading">#</a></h2>
<p>You now have a new Generic IOC that can be used to test the ADUrl plugin.</p>
<p>The next tutorial will discuss how to test this IOC, including publishing
the image to a container registry so that it can run in Kubernetes.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="generic_ioc.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Create a Generic IOC</p>
      </div>
    </a>
    <a class="right-next"
       href="test_generic_ioc.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Testing and Deploying a Generic IOC</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#investigate-the-build-failure">Investigate the Build Failure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-changes-inside-the-container">Making Changes Inside the Container</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-changes-made-inside-the-container">Applying Changes Made Inside the Container</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-easier-fix-using-adsupport">An Easier Fix Using ADSupport</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wrapping-up">Wrapping Up</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/epics-containers/epics-containers.github.io/edit/2024-rework/docs/user/tutorials/debug_generic_ioc.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/user/tutorials/debug_generic_ioc.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>