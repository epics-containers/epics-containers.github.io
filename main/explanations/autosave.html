
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Autosave for IOCs &#8212; epics-containers 4.2.1.dev27+g155b559 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=3503da46"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'explanations/autosave';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://epics-containers.github.io/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'main';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="icon" href="../_static/k8s-epics2.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Change Management Manifesto" href="changes.html" />
    <link rel="prev" title="Explanations" href="../explanations.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="main" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/k8s-epics2.ico" class="logo__image only-light" alt=""/>
    <img src="../_static/k8s-epics2.ico" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">epics-containers</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Autosave for IOCs</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">Change Management Manifesto</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="decisions.html">Architectural Decision Records</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="decisions/0001-record-architecture-decisions.html">1. Record architecture decisions</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions/0002-switched-to-python-copier-template.html">2. Adopt python-copier-template for project structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions/0003-use-substitution-files.html">3. Use of substitution files to generate EPICS Databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions/0004-autosave-req-files.html">4. How to configure autosave for IOCs</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions/0005-python-scripting.html">5. Use Python for scripting inside and outside containers</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="docs-structure.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="epics_protocols.html">EPICS Network Protocols in Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Essential Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc-source.html">Dev Container vs Runtime Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes_cluster.html">Kubernetes Cluster Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="net_protocols.html">Channel Access and Other Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="repositories.html">Source and Registry Locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="rootless.html">Rootless vs Rootfull</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../explanations.html" class="nav-link">Explanations</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Autosave for IOCs</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="autosave-for-iocs">
<h1>Autosave for IOCs<a class="headerlink" href="#autosave-for-iocs" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>Autosave saves the state of an IOC to disk and restores it on restarts. epics-containers manages autosave configuration in a prescriptive fashion that is discussed here.</p>
<p>The official autosave documentation in <a class="reference external" href="https://epics.anl.gov/bcda/synApps/autosave/autoSaveRestore_R5-6-1.html">here</a>.</p>
<p>Different facilities have used different approaches to configuring autosave. epics-containers has settled on using <code class="docutils literal notranslate"><span class="pre">.req</span></code> files. These files simply list the set of PVs to save with autosave. The naming convention for these files is the same as that which the AreaDetector modules have adopted. EPICS Db info tags were also considered but rejected because supplying overrides to them would be problematic.</p>
<p>Because of this, AreaDetector Support modules can use autosave in epics-containers without any additional configuration (unless you disagree with the default choice of saved PVs). Many other support modules have adopted the same approach and will just work.</p>
<p>Other support modules can have their autosave configuration specified in ibek-support or in individual IOC instances.</p>
</section>
<section id="configuring-autosave-for-iocs">
<h2>Configuring autosave for IOCs<a class="headerlink" href="#configuring-autosave-for-iocs" title="Link to this heading">#</a></h2>
<p>To use autosave, the generic IOC being used must have compiled in the autosave module. The following snippet in the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> will do this:</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">COPY</span><span class="w"> </span>ibek-support/autosave/<span class="w"> </span>autosave
<span class="k">RUN</span><span class="w"> </span>ansible.sh<span class="w"> </span>autosave
</pre></div>
</div>
<p>To enable autosave in an IOC instance that uses the above generic IOC requires adding the following to the ioc.yaml instance configuration (our examples are for the motion IOC BL45P-MO-IOC-01):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autosave.Autosave</span>
<span class="w">    </span><span class="nt">P</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BL47P-MO-IOC-01</span><span class="w">      </span><span class="c1"># a prefix for all autosave monitoring PVs</span>
</pre></div>
</div>
</section>
<section id="startup-script">
<h2>Startup Script<a class="headerlink" href="#startup-script" title="Link to this heading">#</a></h2>
<p>The startup script entries that handle autosave will look the similar for all IOC instances as follows.</p>
<p>First in pre init stage we have:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Autosave pre iocInit
set_requestfile_path(&quot;/epics&quot;, &quot;autosave&quot;)
set_savefile_path(&quot;/autosave&quot;)
save_restoreSet_status_prefix BL47P-MO-IOC-01
save_restoreSet_Debug 0
save_restoreSet_NumSeqFiles 3
save_restoreSet_SeqPeriodInSeconds 600
save_restoreSet_DatedBackupFiles 1
save_restoreSet_IncompleteSetsOk 1
set_pass0_restoreFile autosave_positions.sav
set_pass1_restoreFile autosave_settings.sav
asSetFilename $(PVLOGGING)/src/access.acf
</pre></div>
</div>
<p>save_restoreSet values can be adjusted with arguments in the yaml but the pass0 and pass1 save files are fixed for epics-containers. These files will be saved into <code class="docutils literal notranslate"><span class="pre">/autosave</span></code> inside the IOC instance’s container filesystem. Along side them will be the sequence files and dated backup files.</p>
<p><code class="docutils literal notranslate"><span class="pre">/autosave</span></code> will be mounted into the namespace’s autosave Persistent Volume Claim with a subfolder named after the IOC instance. For our BL47P-MO-IOC-01 example we have:</p>
<ul class="simple">
<li><p>namespace: p47-beamline</p></li>
<li><p>PVC name: p47-autosave-claim</p></li>
<li><p>subPath in the PVC: bl47p-mo-ioc-01</p></li>
</ul>
<p>Hence a pod that mounts the root of the PVC <code class="docutils literal notranslate"><span class="pre">p47-autosave-claim</span></code> will be able to browse the autosave files of all IOC instances in the namespace.</p>
<p>After iocInit we have</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Autosave post iocInit</span>
<span class="n">create_monitor_set</span> <span class="n">autosave_positions</span><span class="o">.</span><span class="n">req</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
<span class="n">create_monitor_set</span> <span class="n">autosave_settings</span><span class="o">.</span><span class="n">req</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
<p>The two req files list the PVs and have fixed names in epics-containers:</p>
<ul class="simple">
<li><p>autosave_positions.req: lists PVS to be restored at phase 0 before record processing starts (usually motor positions)</p></li>
<li><p>autosave_settings.req: lists PVS to be restored at phase 1 after record processing starts</p></li>
</ul>
<p>These files are generated by ibek from the req files in the support modules included in the generic IOC but can be also overridden on an instance basis.</p>
</section>
<section id="sources-of-req-files">
<span id="req-sources"></span><h2>Sources of req files<a class="headerlink" href="#sources-of-req-files" title="Link to this heading">#</a></h2>
<p>There are 3 places ibek sources autosave req files from:</p>
<ul class="simple">
<li><p>The built support module may have req files in its <code class="docutils literal notranslate"><span class="pre">Db</span></code> database template folder alongside the Database templates</p></li>
<li><p>The ibek-support subfolder for the support module, these may override the above</p></li>
<li><p>The config folder for the ioc instance, these override both of the above</p></li>
</ul>
<p>In all cases the filenames must follow a strict pattern to identify the template from which the referenced PVs are being sourced. (this is the Areadetector approach). Overriding is simply a matter of creating the same file name in ibek-support or instance config.</p>
<p>Pattern: &lt;template_stem_name&gt;_{positions|settings}.req</p>
<p>e.g.</p>
<ul class="simple">
<li><p>template: basic_asyn_motor.template</p></li>
<li><p>phase 0 .req file: basic_asyn_motor_positions.req</p></li>
<li><p>phase 1 .req file: basic_asyn_motor_settings.req</p></li>
</ul>
</section>
<section id="build-time-behaviour">
<h2>Build time behaviour<a class="headerlink" href="#build-time-behaviour" title="Link to this heading">#</a></h2>
<p>The initial gathering of the <code class="docutils literal notranslate"><span class="pre">.req</span></code> files is done at container build time. Each time <code class="docutils literal notranslate"><span class="pre">ansible.sh</span></code> is executed in the Dockerfile it builds the given support module, but also symlinks all <code class="docutils literal notranslate"><span class="pre">.req</span></code> files from <code class="docutils literal notranslate"><span class="pre">ibek-support/&lt;module&gt;</span></code> to the <code class="docutils literal notranslate"><span class="pre">\epics\autosave</span></code> folder in the container.</p>
<p>These files are provided by the creator of the <code class="docutils literal notranslate"><span class="pre">ibek-support/&lt;support_module&gt;</span></code> module recipe. If the upstream support module includes req files that match the AreaDetector naming convention then there is no need to provide any <code class="docutils literal notranslate"><span class="pre">.req</span></code> files here.</p>
<p>If the support module has <code class="docutils literal notranslate"><span class="pre">.req</span></code> files with a different naming convention then one way to support this is to copy those files into the <code class="docutils literal notranslate"><span class="pre">ibek-support/&lt;support_module&gt;</span></code> folder and rename them appropriately. This is in keeping with the epics-containers philosophy of not requiring changes to the upstream support modules in order to support them. However, if the support module maintainer is open to adopting the defacto standard for <code class="docutils literal notranslate"><span class="pre">.req</span></code> files then that is the preferred approach.</p>
<p>Adding <code class="docutils literal notranslate"><span class="pre">.req</span></code> files to <code class="docutils literal notranslate"><span class="pre">ibek-support</span></code> gives us a way to supply autosave information that has historically been done out of band. DLS have a specific use for this as discussed in <a class="reference internal" href="#dls-autosave"><span class="std std-ref">Diamond Light Source Autosave Approach</span></a>.</p>
</section>
<section id="runtime-behaviour">
<h2>Runtime behaviour<a class="headerlink" href="#runtime-behaviour" title="Link to this heading">#</a></h2>
<p>All of the <code class="docutils literal notranslate"><span class="pre">.req</span></code> files supplied by support modules include the same macros as the templates that their PVs come from. Hence these need to be substituted with values that the individual IOC instance is using before passing to autosave.</p>
<p>In addition the multiple <code class="docutils literal notranslate"><span class="pre">.req</span></code> files from multiple support modules need to be gathered into a single file for each of the autosave phases. These are to be called  <code class="docutils literal notranslate"><span class="pre">autosave_positions.sav.req</span></code> and <code class="docutils literal notranslate"><span class="pre">autosave_settings.req</span></code> and passed to the <code class="docutils literal notranslate"><span class="pre">create_monitor_set</span></code> function as we saw above.</p>
<p>Both file gathering and substitution are handled by ibek in the <code class="docutils literal notranslate"><span class="pre">start.sh</span></code> script that all epics-containers IOC instances use. The command that performs this step is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ibek<span class="w"> </span>runtime<span class="w"> </span>generate-autosave
</pre></div>
</div>
<p>This performs the following steps:</p>
<ul class="simple">
<li><p>symlinks all <code class="docutils literal notranslate"><span class="pre">.req</span></code> files found in the support modules of the generic IOC to <code class="docutils literal notranslate"><span class="pre">\epics\autosave</span></code></p>
<ul>
<li><p>if the file exists then don’t overwrite - allowing the <code class="docutils literal notranslate"><span class="pre">ibek-support</span></code> to provide overrides</p></li>
</ul>
</li>
<li><p>symlinks all <code class="docutils literal notranslate"><span class="pre">.req</span></code> files found in <code class="docutils literal notranslate"><span class="pre">\epics\ioc\config</span></code> to <code class="docutils literal notranslate"><span class="pre">\epics\autosave</span></code></p>
<ul>
<li><p>overwriting any existing files thus providing instance overrides</p></li>
</ul>
</li>
<li><p>generates two substitution files</p>
<ul>
<li><p>/epics/runtime/autosave_positions.subst</p></li>
<li><p>/epics/runtime/autosave_settings.subst</p></li>
</ul>
</li>
<li><p>runs MSI over the above substitution files, with the path pointing to <code class="docutils literal notranslate"><span class="pre">\epics\autosave</span></code></p></li>
</ul>
<p>The substitution files are copies of <code class="docutils literal notranslate"><span class="pre">/epics/runtime/ioc.subst</span></code> except that the EPICS Db template file names are replaced with autosave req file names using the naming convention described in <a class="reference internal" href="#req-sources"><span class="std std-ref">Sources of req files</span></a>.</p>
<p>The MSI output is two files <code class="docutils literal notranslate"><span class="pre">autosave_positions.sav.req</span></code> and <code class="docutils literal notranslate"><span class="pre">autosave_settings.req</span></code> which are in turn passed to <code class="docutils literal notranslate"><span class="pre">create_monitor_set</span></code> in the startup script.z</p>
</section>
<section id="diamond-light-source-autosave-approach">
<span id="dls-autosave"></span><h2>Diamond Light Source Autosave Approach<a class="headerlink" href="#diamond-light-source-autosave-approach" title="Link to this heading">#</a></h2>
<p>At DLS we generate our .req files from comments added to the template files. This has had the unfortunate side effect of making DLS forks of support modules deviate from upstream. This does not fit well with the epics-containers philosophy of using upstream support modules without modification.</p>
<p>For this reason we supply a tool to extract the comment information from the internal DLS fork of the support modules and generate the <code class="docutils literal notranslate"><span class="pre">.req</span></code> files.</p>
<p>This tool should be used when:</p>
<ul class="simple">
<li><p>the upstream support module does not provide <code class="docutils literal notranslate"><span class="pre">.req</span></code> files in the AreaDetector style</p></li>
<li><p>the DLS fork of the support module has autosave comments in the template files</p></li>
<li><p>the module is DLS internal or is public but originated from DLS</p></li>
</ul>
<p>The tool is called <code class="docutils literal notranslate"><span class="pre">builder2ibek</span></code> and can be installed from PyPi.</p>
<p>The following example was used to extract the autosave information from the <code class="docutils literal notranslate"><span class="pre">pmac</span></code> module:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/dls_sw/prod/R3.14.12.7/support/pmac/2-5-22
builder2ibek<span class="w"> </span>autosave<span class="w"> </span>db/*<span class="w"> </span>--out-folder<span class="w"> </span>/scratch/hgv27681/work/ioc-pmac/ibek-support/pmac
</pre></div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../explanations.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Explanations</p>
      </div>
    </a>
    <a class="right-next"
       href="changes.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Change Management Manifesto</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuring-autosave-for-iocs">Configuring autosave for IOCs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#startup-script">Startup Script</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sources-of-req-files">Sources of req files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#build-time-behaviour">Build time behaviour</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#runtime-behaviour">Runtime behaviour</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#diamond-light-source-autosave-approach">Diamond Light Source Autosave Approach</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/epics-containers/epics-containers.github.io/edit/main/docs/explanations/autosave.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/explanations/autosave.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>