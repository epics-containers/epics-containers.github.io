
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Essential Concepts &#8212; epics-containers 3.4.2.dev36+g0b67051 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=7268434d"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'explanations/introduction';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://epics-containers.github.io/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'main';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../_static/k8s-epics2.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Dev Container vs Runtime Container" href="ioc-source.html" />
    <link rel="prev" title="About the documentation" href="docs-structure.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/k8s-epics2.ico" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../_static/k8s-epics2.ico" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">epics-containers</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="changes.html">Change Management Manifesto</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="decisions.html">Architectural Decision Records</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="decisions/0001-record-architecture-decisions.html">1. Record architecture decisions</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions/0002-switched-to-python-copier-template.html">2. Adopt python-copier-template for project structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions/0003-use-substitution-files.html">3. Use of substitution files to generate EPICS Databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions/0004-autosave-req-files.html">4. How to configure autosave for IOCs</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions/0005-python-scripting.html">5. Use Python for scripting inside and outside containers</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="docs-structure.html">About the documentation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Essential Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc-source.html">Dev Container vs Runtime Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes_cluster.html">Kubernetes Cluster Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="net_protocols.html">Channel Access and Other Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="repositories.html">Source and Registry Locations</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../explanations.html" class="nav-link">Explanations</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Essential Concepts</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="essential-concepts">
<span id="essential"></span><h1>Essential Concepts<a class="headerlink" href="#essential-concepts" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p><strong>epics-containers</strong> applies modern industry best practice for software
delivery to the management of EPICS IOCs.</p>
<p>There are 5 themes to this strategy:</p>
<dl class="field-list simple">
<dt class="field-odd">Containers<span class="colon">:</span></dt>
<dd class="field-odd"><p>Package IOC software and execute it in a lightweight virtual environment​</p>
</dd>
<dt class="field-even">Kubernetes<span class="colon">:</span></dt>
<dd class="field-even"><p>Centrally orchestrates all IOCs at a facility.</p>
</dd>
<dt class="field-odd">Helm Charts<span class="colon">:</span></dt>
<dd class="field-odd"><p>Deploy IOCs into Kubernetes with version management.</p>
</dd>
<dt class="field-even">Repositories<span class="colon">:</span></dt>
<dd class="field-even"><p>Source, container and helm repositories manage all of the above assets.
No shared file systems required.</p>
</dd>
<dt class="field-odd">Continuous Integration / Continuous Deployment<span class="colon">:</span></dt>
<dd class="field-odd"><p>Source repositories automatically build containers and helm charts,
delivering them to OCI registries. Services repositories automatically deploy
IOCs to Kubernetes clusters using ArgoCD.</p>
</dd>
</dl>
<p>See below for more details on each of these.</p>
</section>
<section id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Link to this heading">#</a></h2>
<section id="images-and-containers">
<h3>Images and Containers<a class="headerlink" href="#images-and-containers" title="Link to this heading">#</a></h3>
<p>Containers provide the means to package up IOC software and execute it
in a lightweight virtual environment. These packages are then saved
into public or private image registries such as DockerHub or Github Container
Registry.</p>
<p>The Open Container Initiative (OCI) defines the set of container services
and their APIs such that container images can be interchanged between
different frameworks.</p>
<p>Thus, in this project we develop, build and test our container images
using docker or podman but the images can be run under Kubernetes’ own
container runtime.</p>
<p>This article does a good job of explaining the relationship between docker /
containers and Kubernetes <a class="reference external" href="https://semaphoreci.com/blog/kubernetes-vs-docker">https://semaphoreci.com/blog/kubernetes-vs-docker</a></p>
<p>An important outcome of using containers is that you can alter the
environment inside the container to suit the IOC code, instead of altering the
code to suit your infrastructure. At DLS, this means that we are able to use
vanilla EPICS base and support modules. We no longer require our own
forks of these repositories.</p>
<section id="generic-iocs-and-instances">
<span id="generic-iocs"></span><h4>Generic IOCs and instances<a class="headerlink" href="#generic-iocs-and-instances" title="Link to this heading">#</a></h4>
<p>An important principal of the approach presented here is that an IOC container image represents a ‘Generic’ IOC. The Generic IOC image is used for all IOC instances that connect to a given class of device. For example the Generic IOC image here: <a class="reference external" href="https://github.com/epics-containers/ioc-adaravis/pkgs/container/ioc-adaravisruntime">ghcr.io/epics-containers/ioc-adaravis-runtime:2024.2.2 </a> uses the AreaDetector driver ADAravis to connect to GigE cameras.</p>
<p>The generic IOC image contains:</p>
<ul class="simple">
<li><p>a set of compiled support modules</p></li>
<li><p>a compiled IOC binary that links all those modules</p></li>
<li><p>a dbd file for all the support modules.</p></li>
</ul>
<p>It does not contain a startup script pr EPICS database, these are instance specific and added at runtime.</p>
<p>An IOC instance runs in a container runtime by loading two things:</p>
<ul class="simple">
<li><p>The Generic IOC image passed to the container runtime.</p></li>
<li><p>The IOC instance configuration. This is mapped into the container at  runtime by mounting it into the filesystem. The mount point for this configuration is usually the folder <code class="docutils literal notranslate"><span class="pre">/epics/ioc/config</span></code>.</p></li>
</ul>
<p>The configuration will bootstrap the unique properties of that instance. The following contents for the configuration folder are supported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ioc.yaml</span></code>: an <strong>ibek</strong> IOC description file which <strong>ibek</strong> will use to generate
st.cmd and ioc.subst.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">st.cmd</span></code> and <code class="docutils literal notranslate"><span class="pre">ioc.subst</span></code>: an IOC shell startup script and an optional substitution file.
st.cmd can refer to any additional files in the configuration directory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">start.sh</span></code>: a bash script to fully override the startup of the IOC. start.sh
can refer to any additional files in the configuration directory.</p></li>
</ul>
<p>This approach reduces the number of images required and saves disk and memory. It also makes for simpler configuration management.</p>
<p>Throughout this documentation we will use the terms Generic IOC and IOC Instance. The word IOC without this context is ambiguous.</p>
</section>
</section>
<section id="kubernetes">
<h3>Kubernetes<a class="headerlink" href="#kubernetes" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://kubernetes.io/">https://kubernetes.io/</a></p>
<p>Kubernetes efficiently manages containers across clusters of hosts. It builds upon years of experience of running production workloads at Google, combined with best-of-breed ideas and practices from the community, since it was open-sourced in 2014.</p>
<p>Today Kubernetes is by far the dominant orchestration system for containers. It is managed by The Cloud Native Computing Foundation (CNCF) which is part of the Linux Foundation. You can read about its active community here <a class="reference external" href="https://www.cncf.io/">https://www.cncf.io/</a>.</p>
<p>When deploying an IOC into a Kubernetes cluster, you request the resources needed by the IOC and Kubernetes will then schedule the IOC onto a suitable host with sufficient resources.</p>
<p>In this project we use Kubernetes and Helm (the package manager for Kubernetes) to provide a standard way of
implementing these features:</p>
<ul class="simple">
<li><p>Auto start IOCs when the cluster comes up from power off</p></li>
<li><p>Allocate a server with adequate resources on which to run each IOC</p></li>
<li><p>Manually Start and Stop IOCs</p></li>
<li><p>Monitor IOC health, automatically restart IOCs that have failed</p></li>
<li><p>Deploy versioned IOCs to the beamline</p></li>
<li><p>Report the versions, uptime, restarts and other metadata of the IOCs</p></li>
<li><p>Rollback an IOC to a previous version</p></li>
<li><p>Failover to another server (for soft IOCs not tied to hardware in a server) if the server fails</p></li>
<li><p>View the current log</p></li>
<li><p>View historical logs (via graylog or other centralized logging system)</p></li>
<li><p>Connect to an IOC and interact with its shell</p></li>
<li><p>debug an IOC by starting a bash shell inside it’s container</p></li>
</ul>
</section>
<section id="kubernetes-alternatives">
<h3>Kubernetes Alternatives<a class="headerlink" href="#kubernetes-alternatives" title="Link to this heading">#</a></h3>
<p>If you do not wish to maintain a Kubernetes cluster then you could simply install IOCs directly into the local docker or podman instance on each server. Instead of using Kubernetes and Helm, you can use docker compose to manage such IOC instances. But this is just an example, epics-containers is intended to be modular so that you can make use of any parts of it without adopting the whole framework as used at DLS.</p>
<p>We provide a template services project that uses docker compose with docker or podman as the runtime engine. Docker compose allows us to describe a set of IOCs and other services for each beamline server, similar to the way Helm does. Where a beamline has multiple servers, the distribution of IOCs across those servers could be managed by maintaining a separate docker-compose file for each server in the root of the services repository.</p>
<p>If you choose to use this approach then you may find it useful to have another tool for viewing and managing the set of containers you have deployed across your beamline servers. There are various solutions for this, one that has been tested with <strong>epics-containers</strong> is Portainer <a class="reference external" href="https://www.portainer.io/">https://www.portainer.io/</a>. Portainer is a paid for product that provides excellent visibility and control of your containers through a web interface. Such a tool could allow you to centrally manage the containers on all your servers.</p>
<p>The multi-server orchestration tool Docker Swarm might also serve to replace some of the functionality of Kubernetes. The epics-containers team have not yet tried Swarm, but it is compatible with the docker-compose files we template.</p>
</section>
<section id="helm">
<h3>Helm<a class="headerlink" href="#helm" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://helm.sh/">https://helm.sh/</a></p>
<p>Helm is the most popular package manager for Kubernetes applications.</p>
<p>The packages are called Helm Charts. They contain templated YAML files to
define a set of resources to apply to a Kubernetes cluster.</p>
<p>Helm has functions to deploy Charts to a cluster and manage multiple versions
of the Chart within the cluster.</p>
<p>It also supports registries for storing version history of Charts,
much like docker.</p>
<p>In this project we use Helm Charts to define and deploy IOC instances. IOCs are grouped into a <a class="reference internal" href="../reference/glossary.html#services-repo"><span class="std std-ref">services repository</span></a>. Typical services repositories represent a beamline or accelerator technical area but any grouping is allowed. Each of these repositories holds the Helm Charts for its IOC Instances and any other services we require. Each IOC instance folder need only contain:</p>
<ul class="simple">
<li><p>a values.yaml file to override the default values in the repository’s global values.yaml.</p></li>
<li><p>a config folder as described in <a class="reference internal" href="#generic-iocs"><span class="std std-ref">Generic IOCs and instances</span></a>.</p></li>
<li><p>a couple of boilerplate Helm files that are the same for all IOCs.</p></li>
</ul>
<p><strong>epics-containers</strong> does not use helm registries for storing each IOC instance. Such registries only hold a zipped version of the Chart files, and this is redundant when we have a git repository holding the same information. Instead a single global helm chart represents the shared elements between all IOC instances and is stored in a helm registry. Each folder in the services repository is itself a helm chart that includes that global chart as a dependency.</p>
</section>
<section id="repositories">
<h3>Repositories<a class="headerlink" href="#repositories" title="Link to this heading">#</a></h3>
<p>All of the assets required to manage all of the IOC Instances for a facility are held in repositories.</p>
<p>Thus all version control is done via these repositories and no special locations in a shared filesystem are required. (The legacy approach at DLS relied heavily on know locations in a shared filesystem).</p>
<p>In the <strong>epics-containers</strong> examples all repositories are held in the same github organization. This is nicely contained and means that only one set of credentials is required to access all the resources.</p>
<p>There are many alternative services for storing these repositories, both in the cloud and on premises. Below we list the choices we have tested during the proof of concept.</p>
<p>The most common classes of repository are as follows:</p>
<dl class="field-list">
<dt class="field-odd">Generic IOC Source Repositories<span class="colon">:</span></dt>
<dd class="field-odd"><p>Define how a Generic IOC image is built, this does not typically include source code, but instead is a set of instructions for building the Generic IOC image by compiling source from a number of upstream support module repositories. Boilerplate IOC source code is also included in the Generic IOC source repository and can be customized if needed. These have been tested:</p>
<ul class="simple">
<li><p>GitHub</p></li>
<li><p>GitLab (on premises)</p></li>
</ul>
</dd>
<dt class="field-even">Services Source Repositories<span class="colon">:</span></dt>
<dd class="field-even"><p>Define the IOC instances and other services for a beamline, accelerator technical area or any other grouping strategy. These have been tested:</p>
<ul class="simple">
<li><p>GitHub</p></li>
<li><p>GitLab (on premises)</p></li>
</ul>
</dd>
<dt class="field-odd">An OCI Image Registry<span class="colon">:</span></dt>
<dd class="field-odd"><p>Holds the Generic IOC container images and their dependencies. Also used to hold the helm Charts that define the shared elements between all domains.</p>
<p>The following have been tested:</p>
<ul class="simple">
<li><p>Github Container Registry</p></li>
<li><p>DockerHub</p></li>
<li><p>Google Cloud Container Registry</p></li>
</ul>
</dd>
</dl>
</section>
<section id="continuous-integration">
<h3>Continuous Integration<a class="headerlink" href="#continuous-integration" title="Link to this heading">#</a></h3>
<p>Our examples all use continuous integration to get from pushed source
to the published images, IOC instances Helm Charts and documentation.</p>
<p>This allows us to maintain a clean code base that is continually tested for
integrity and also to maintain a direct relationship between source code version
tags and the tags of their built resources.</p>
<p>There are these types of CI:</p>
<dl class="field-list simple">
<dt class="field-odd">Generic IOC source<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>builds a Generic IOC container image</p></li>
<li><p>runs some tests against that image - these will eventually include
system tests that talk to simulated hardware</p></li>
<li><p>publishes the image to github packages (only if the commit is tagged)
or other OCI registry</p></li>
</ul>
</dd>
<dt class="field-even">Services Source<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>prepares a helm Chart from each IOC instance or other service definition</p></li>
<li><p>tests that the helm Chart is deployable (but does not deploy it)</p></li>
<li><p>locally launches each IOC instance and loads its configuration to
verify that the configuration is valid (no system tests because this
would require talking to real hardware instances).</p></li>
</ul>
</dd>
<dt class="field-odd">Documentation Source<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>builds the sphinx docs that you are reading now</p></li>
<li><p>publishes it to github.io pages with version tag or branch tag.</p></li>
</ul>
</dd>
<dt class="field-even">Global Helm Chart Source<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ec-helm-chars</span></code> repo only</p></li>
<li><p>packages a helm Chart from source</p></li>
<li><p>publishes it to github packages (only if the commit is tagged)
or other OCI registry</p></li>
</ul>
</dd>
</dl>
</section>
<section id="continuous-deployment">
<h3>Continuous Deployment<a class="headerlink" href="#continuous-deployment" title="Link to this heading">#</a></h3>
<p>ArgoCD is a Kubernetes controller that continuously monitors running applications and compares their current state with the desired state described in a git repository. If the current state does not match the desired state, ArgoCD will attempt to reconcile the two.</p>
<p>For this purpose each services repository will have a companion deployment repository which tracks which version of each IOC in the services repository should currently be deployed to the cluster. This list of IOC versions is in a single YAML file and updating this file and pushing it to the deployment repository will trigger ArgoCD to update the cluster accordingly.</p>
<p>In this fashion changes to IOC versions are tracked in git and it is easy to roll back to the same state as a given date because there is a complete record.</p>
</section>
</section>
<section id="scope">
<h2>Scope<a class="headerlink" href="#scope" title="Link to this heading">#</a></h2>
<p>This project initially targets x86_64 Linux Soft IOCs and RTEMS ‘hard’ IOCs running on MVME5500 hardware. Soft IOCs that require access to hardware on the server (e.g. USB or PCIe) will be supported by mounting the hardware into the container (these IOCS will not support Kubernetes failover).</p>
<p>Other linux architectures could be added to the Kubernetes cluster. We have tested arm64 native builds and will add this as a supported architecture in the future.</p>
<p>Python soft IOCs are also supported. See <a class="github reference external" href="https://github.com/DiamondLightSource/pythonSoftIOC">DiamondLightSource/pythonSoftIOC</a></p>
<p>GUI generation for engineering screens is supported via the PVI project. See <a class="github reference external" href="https://github.com/epics-containers/pvi">epics-containers/pvi</a>.</p>
</section>
<section id="additional-tools">
<h2>Additional Tools<a class="headerlink" href="#additional-tools" title="Link to this heading">#</a></h2>
<section id="edge-containers-cli">
<h3>edge-containers-cli<a class="headerlink" href="#edge-containers-cli" title="Link to this heading">#</a></h3>
<p>This is the ‘outside of the container’ helper tool. The command
line entry point is <strong>ec</strong>.</p>
<p>The project is a python package featuring simple command line functions for deploying and monitoring IOC instances. It is a thin wrapper around the ArgoCD, kubectl, helm and git commands. This tool can be used by developers and beamline staff to get a quick CLI based view of IOCs running in the cluster, as well as stop/start and obtain logs from them.</p>
<p>See <a class="reference internal" href="../reference/cli.html#cli"><span class="std std-ref">Command Line Interface for IOC Management</span></a> for more details.</p>
</section>
<section id="ibek">
<h3><strong>ibek</strong><a class="headerlink" href="#ibek" title="Link to this heading">#</a></h3>
<p>IOC Builder for EPICS and Kubernetes is the developer’s ‘inside the container’ helper tool. It is a python package that is installed into the Generic IOC container images. It is used:</p>
<ul class="simple">
<li><p>at container build time: to fetch and build EPICS support modules</p></li>
<li><p>at container run time: to generate all useful build artifacts into a runtime image e.g. generating the st.cmd and ioc.db file from the ioc.yaml configuration file.</p></li>
<li><p>inside the developer container: to assist with testing and debugging.</p></li>
</ul>
<p>See <a class="github reference external" href="https://github.com/epics-containers/ibek">epics-containers/ibek</a>.</p>
</section>
<section id="pvi">
<h3>PVI<a class="headerlink" href="#pvi" title="Link to this heading">#</a></h3>
<p>The Process Variables Interface project is a python package that is installed inside Generic IOC container images. It is used to give structure to the IOC’s Process Variables allowing us to:</p>
<ul class="simple">
<li><p>add metadata to the IOCs DB records for use by <a class="reference external" href="https://blueskyproject.io/">Bluesky</a> and <a class="reference external" href="https://github.com/bluesky/ophyd-async">Ophyd</a></p></li>
<li><p>auto generate screens for the device (as bob, adl or edm files)</p></li>
</ul>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="docs-structure.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">About the documentation</p>
      </div>
    </a>
    <a class="right-next"
       href="ioc-source.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Dev Container vs Runtime Container</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#concepts">Concepts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#images-and-containers">Images and Containers</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#generic-iocs-and-instances">Generic IOCs and instances</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubernetes">Kubernetes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubernetes-alternatives">Kubernetes Alternatives</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#helm">Helm</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#repositories">Repositories</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#continuous-integration">Continuous Integration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#continuous-deployment">Continuous Deployment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scope">Scope</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-tools">Additional Tools</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#edge-containers-cli">edge-containers-cli</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ibek"><strong>ibek</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pvi">PVI</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/epics-containers/epics-containers.github.io/edit/main/docs/explanations/introduction.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/explanations/introduction.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>