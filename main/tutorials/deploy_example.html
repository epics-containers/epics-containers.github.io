


<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Deploy The Example IOC &mdash; epics_containers 0.4+10.g00d17b5 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/k8s-epics2.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Manage IOCs" href="manage_iocs.html" />
    <link rel="prev" title="Create a beamline repository" href="create_beamline.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: rgb(7, 43, 93)" >
          

          
            <a href="../index.html" class="icon icon-home"> epics_containers
          

          
            
            <img src="../_static/k8s-epics2.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                main
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
  <style>
    /* style mobile top nav to look like main nav */
    .wy-nav-top {
        background: rgb(7, 43, 93)
    }
  </style>
  
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup_k8s.html">Setup a Kubernetes Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="useful_k8s.html">Useful Kubernetes Additions</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_beamline.html">Create a beamline repository</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Deploy The Example IOC</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#initial-setup">Initial Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deploy-an-ioc-version">Deploy an IOC Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="#launching-a-gui-to-interact-with-your-ioc">Launching a GUI to interact with your IOC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#learning-about-helm-and-kubernetes-manifests">Learning about Helm and Kubernetes Manifests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="manage_iocs.html">Manage IOCs</a></li>
</ul>
<p class="caption"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/introduction.html">Essential Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/whats_in.html">epics-containers Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/net_protocols.html">Channel Access and Other Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/kubernetes_cluster.html">Kubernetes Cluster Config</a></li>
</ul>
<p class="caption"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/add_ioc.html">Add an IOC instance to a beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/create_ioc.html">Create a new generic IOC image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/generic_iocs.html">Run an IOC without Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/debug.html">Debug an IOC instance locally</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/debug.html#debug-an-ioc-instance-in-kubernetes">Debug an IOC instance in Kubernetes</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/cli.html">Command Line Interface for IOC Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/contributing.html">Contributing</a></li>
</ul>

            
          
  <!-- Include all versions of the docs -->
  <!-- https://holzhaus.github.io/sphinx-multiversion/master/templates.html -->
  
  <p class="caption"><span class="caption-text">Versions</span></p>
  <ul>
    <li><a href="deploy_example.html">main</a></li>
  </ul>
  

        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">epics_containers</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Deploy The Example IOC</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorials/deploy_example.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deploy-the-example-ioc">
<h1>Deploy The Example IOC<a class="headerlink" href="#deploy-the-example-ioc" title="Permalink to this headline">¶</a></h1>
<div class="section" id="initial-setup">
<h2>Initial Setup<a class="headerlink" href="#initial-setup" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial step we will deploy and interact with the example ioc
that came with the beamline source template we used in the previous step.</p>
<p>For this step it is assumed that you have Kubernetes set up and kubectl
installed on your workstation. Also there is an epics-iocs namespace
configured and your context is setup to default into that namespace. Finally
helm must also be installed.</p>
<p>For instructions on how to set up Kubernetes, kubectl and helm
see <a class="reference internal" href="setup_k8s.html#setup-kubernetes"><span class="std std-ref">Setup a Kubernetes Server</span></a>.</p>
<p>To save on typing the script kube-functions.sh provides some shell
functions which are simply wrappers for kubectl and helm commands. To
learn about the commands take a look at the script.</p>
<p>Source kube-functions.sh into your shell as follows. NOTE: replace
gilesknap with your account:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">K8S_HELM_REGISTRY</span><span class="o">=</span><span class="n">ghcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">gilesknap</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">q</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">epics</span><span class="o">-</span><span class="n">containers</span><span class="o">/</span><span class="n">k8s</span><span class="o">-</span><span class="n">epics</span><span class="o">-</span><span class="n">utils</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">epics</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="n">image</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">functions</span><span class="o">.</span><span class="n">sh</span>
<span class="n">source</span> <span class="n">kube</span><span class="o">-</span><span class="n">functions</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</div>
<div class="section" id="deploy-an-ioc-version">
<h2>Deploy an IOC Version<a class="headerlink" href="#deploy-an-ioc-version" title="Permalink to this headline">¶</a></h2>
<p>In the previous tutorial we pushed tag 0.1 to gilesknap/bl00i and this
generated a helm chart at ghcr.io/gilesknap with tags 0.1 and latest.</p>
<p>To deploy the helm chart into your cluster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">k8s</span><span class="o">-</span><span class="n">ioc</span> <span class="n">deploy</span> <span class="n">example</span> <span class="mf">0.1</span>
</pre></div>
</div>
<p>It may take a while for the first launch because Kubernetes needs to pull
the generic IOC image from the repository. The following command will give
details of the resources associated with the example IOC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">k8s</span><span class="o">-</span><span class="n">ioc</span> <span class="nb">list</span> <span class="n">example</span>
</pre></div>
</div>
<p>When the output looks like this, your IOC is running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                          <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pod</span><span class="o">/</span><span class="n">example</span><span class="o">-</span><span class="mi">6779</span><span class="n">d4dcf</span><span class="o">-</span><span class="n">g2cpm</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">50</span><span class="n">s</span>

<span class="n">NAME</span>                      <span class="n">READY</span>   <span class="n">UP</span><span class="o">-</span><span class="n">TO</span><span class="o">-</span><span class="n">DATE</span>   <span class="n">AVAILABLE</span>   <span class="n">AGE</span>
<span class="n">deployment</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">example</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="mi">1</span>            <span class="mi">1</span>           <span class="mi">50</span><span class="n">s</span>

<span class="n">NAME</span>                                <span class="n">DESIRED</span>   <span class="n">CURRENT</span>   <span class="n">READY</span>   <span class="n">AGE</span>
<span class="n">replicaset</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">example</span><span class="o">-</span><span class="mi">6779</span><span class="n">d4dcf</span>   <span class="mi">1</span>         <span class="mi">1</span>         <span class="mi">1</span>       <span class="mi">50</span><span class="n">s</span>
</pre></div>
</div>
</div>
<div class="section" id="launching-a-gui-to-interact-with-your-ioc">
<h2>Launching a GUI to interact with your IOC<a class="headerlink" href="#launching-a-gui-to-interact-with-your-ioc" title="Permalink to this headline">¶</a></h2>
<p>OPI screens are outside of the scope of this project for the moment see
<a class="reference internal" href="../reference/faq.html#no-opi"><span class="std std-ref">Why no mention of Operator Interfaces?</span></a>.</p>
<p>However to make this example usable we have supplied some edm screens and
will use a local edm container to display these. For this purpose you will
require docker (or podman) installed on your workstation and your user
will need to be in the docker group.</p>
<p>See here <a class="reference external" href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install/</a> for instructions for
installing docker.</p>
<p>To launch the GUI for the example IOC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">bl00i</span>
<span class="o">./</span><span class="n">opi</span><span class="o">/</span><span class="n">stexample</span><span class="o">-</span><span class="n">gui</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>The IOC is a simulated detector with a PVA plugin. It will be possible to
run a PVA viewer to see the output of this IOC.</p>
<p>The main screen of the edm OPI should look like this.</p>
<img alt="../_images/edm_pco.png" class="align-center" src="../_images/edm_pco.png" />
</div>
<div class="section" id="learning-about-helm-and-kubernetes-manifests">
<h2>Learning about Helm and Kubernetes Manifests<a class="headerlink" href="#learning-about-helm-and-kubernetes-manifests" title="Permalink to this headline">¶</a></h2>
<p>It is instructive to see what helm is doing when you deploy the example IOC.</p>
<p>Helm uses templates to generate a set of YAML resources and applies them
to the cluster using kubectl.</p>
<p>We are using a helm library defined in
<a class="reference external" href="https://github.com/epics-containers/helm-ioc-lib">https://github.com/epics-containers/helm-ioc-lib</a>. You can see the templates
it is using in its templates folder.</p>
<p>The example ioc folder itself has a templates folder containing the ioc.yaml
template. This includes all of the templates from helm-ioc-lib and
also generates a ConfigMap resource from the files in the config folder.</p>
<p>To see the YAML that helm is generating you can use the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">bl00i</span>
<span class="n">helm</span> <span class="n">dependency</span> <span class="n">update</span> <span class="n">iocs</span><span class="o">/</span><span class="n">example</span><span class="o">/</span>
<span class="n">helm</span> <span class="n">template</span> <span class="n">example</span> <span class="n">iocs</span><span class="o">/</span><span class="n">example</span>
</pre></div>
</div>
<p>This is using the helm chart in your local filesystem rather than the one
that we pushed to the registry so this is useful for your inner dev loop
testing. You can also deploy directly from the local copy with this
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">upgrade</span> <span class="o">--</span><span class="n">install</span> <span class="n">example</span> <span class="n">iocs</span><span class="o">/</span><span class="n">example</span>
</pre></div>
</div>
<p>This is recommended for testing only since you won’t easily be able to track
versions deployed in this way.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="manage_iocs.html" class="btn btn-neutral float-right" title="Manage IOCs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="create_beamline.html" class="btn btn-neutral float-left" title="Create a beamline repository" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Diamond Light Source.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>