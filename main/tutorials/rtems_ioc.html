
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>RTEMS - Deploying an Example IOC &#8212; epics-containers 3.4.0b4.dev2+g499c231 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=aa6a9eb9"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/rtems_ioc';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.2';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://epics-containers.github.io/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'main';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../_static/k8s-epics2.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How-to Guides" href="../how-to.html" />
    <link rel="prev" title="RTEMS - Creating a File Server" href="rtems_setup.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/k8s-epics2.ico" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../_static/k8s-epics2.ico" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">epics-containers</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../how-to.html">
                        How-to Guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../explanations.html">
                        Explanations
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference.html">
                        Reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../tutorials.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../how-to.html">
                        How-to Guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../explanations.html">
                        Explanations
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference.html">
                        Reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/epics-containers/epics-containers.github.io" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/epics-containers" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Tutorials Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup_workstation.html">Set up a Developer Workstation</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_beamline.html">Create a Beamline Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_example.html">Deploying and Managing IOC Instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_ioc.html">Create an IOC Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_container.html">Developer Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc_changes1.html">Changing the IOC Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc_changes2.html">Changing a Generic IOC</a></li>
<li class="toctree-l1"><a class="reference internal" href="generic_ioc.html">Create a Generic IOC</a></li>

<li class="toctree-l1"><a class="reference internal" href="debug_generic_ioc.html">Debugging Generic IOC Builds</a></li>
<li class="toctree-l1"><a class="reference internal" href="support_module.html">Working with Support Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup_k8s.html">Setup a Kubernetes Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup_k8s_new_beamline.html">Create a New Kubernetes Beamline</a></li>


<li class="toctree-l1"><a class="reference internal" href="rtems_setup.html">RTEMS - Creating a File Server</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">RTEMS - Deploying an Example IOC</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../tutorials.html" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">RTEMS -...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="rtems-deploying-an-example-ioc">
<h1>RTEMS - Deploying an Example IOC<a class="headerlink" href="#rtems-deploying-an-example-ioc" title="Link to this heading">#</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This tutorial is out of date and will be updated in December 2023.</p>
</div>
<p>The previous tutorials walked through how to create a Generic linux soft
IOC and how to deploy an IOC instance using that Generic IOC.</p>
<p>epics-containers also supports RTEMS 5 running on MVVME5500. We will
now will look at the differences for this architecture. Further
architectures will be supported in future.</p>
<p>Each beamline or accelerator domain will require a server for
serving the IOC binaries and instance files to the RTEMS devices. This
needs to be set up for your test beamline before proceeding,
see <a class="reference internal" href="rtems_setup.html"><span class="doc">RTEMS - Creating a File Server</span></a>.</p>
<p>Once you have the file server set up, deploying an IOC instance that uses
an RTEMS Generic IOC is very similar to <a class="reference internal" href="deploy_example.html"><span class="doc">Deploying and Managing IOC Instances</span></a>.</p>
<p>We will be adding
a new IOC instance to the <code class="docutils literal notranslate"><span class="pre">bl01t</span></code> beamline that we created in the previous
tutorials. You will need to have worked through the previous tutorials in
order to complete this one.</p>
<section id="preparing-the-rtems-boot-loader">
<h2>Preparing the RTEMS Boot loader<a class="headerlink" href="#preparing-the-rtems-boot-loader" title="Link to this heading">#</a></h2>
<p>To try this tutorial you will need a VME crate with an MVVME5500 processor card
installed. You will also need access to the serial console over ethernet
using a terminal server or similar.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>DLS Users</strong> for details of setting up RTEMS on your VME crates see
this <a class="reference external" href="https://confluence.diamond.ac.uk/pages/viewpage.action?spaceKey=CNTRLS&amp;amp;title=RTEMS">internal link</a></p>
<p>The following crate is already running RTEMS and can be used for this
tutorial, but check with the accelerator controls team before using it:</p>
<dl class="field-list simple">
<dt class="field-odd">console<span class="colon">:</span></dt>
<dd class="field-odd"><p>ts0001 7007</p>
</dd>
<dt class="field-even">crate monitor<span class="colon">:</span></dt>
<dd class="field-even"><p>ts0001 7008</p>
</dd>
</dl>
<p>It is likely already set up as per the example below.</p>
</div>
<p>Use telnet to connect to the console of your target IOC. e.g.
<code class="docutils literal notranslate"><span class="pre">telnet</span> <span class="pre">ts0001</span> <span class="pre">7007</span></code>. We want to get to the MOTLoad prompt which should look
like <code class="docutils literal notranslate"><span class="pre">MVME5500&gt;</span></code>. If you see an IOC Shell prompt instead hit <code class="docutils literal notranslate"><span class="pre">Ctrl-D</span></code> to
exit and then <code class="docutils literal notranslate"><span class="pre">Esc</span></code> when you see
<code class="docutils literal notranslate"><span class="pre">Boot</span> <span class="pre">Script</span> <span class="pre">-</span> <span class="pre">Press</span> <span class="pre">&lt;ESC&gt;</span> <span class="pre">to</span> <span class="pre">Bypass,</span> <span class="pre">&lt;SPC&gt;</span> <span class="pre">to</span> <span class="pre">Continue</span></code></p>
<p>Now you want to set the boot script to load the IOC binary from the network via
TFTP and mount the instance files from the network via NFS. The command
<code class="docutils literal notranslate"><span class="pre">gevShow</span></code> will show you the current state of the global environment variables.
e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MVME5500</span><span class="o">&gt;</span> <span class="n">gevShow</span>
<span class="n">mot</span><span class="o">-/</span><span class="n">dev</span><span class="o">/</span><span class="n">enet0</span><span class="o">-</span><span class="n">cipa</span><span class="o">=</span><span class="mf">172.23.250.15</span>
<span class="n">mot</span><span class="o">-/</span><span class="n">dev</span><span class="o">/</span><span class="n">enet0</span><span class="o">-</span><span class="n">snma</span><span class="o">=</span><span class="mf">255.255.240.0</span>
<span class="n">mot</span><span class="o">-/</span><span class="n">dev</span><span class="o">/</span><span class="n">enet0</span><span class="o">-</span><span class="n">gipa</span><span class="o">=</span><span class="mf">172.23.240.254</span>
<span class="n">mot</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">device</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">em1</span>
<span class="n">rtems</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">bl01t</span><span class="o">-</span><span class="n">ea</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">02</span>
<span class="n">epics</span><span class="o">-</span><span class="n">script</span><span class="o">=</span><span class="mf">172.23.168.203</span><span class="p">:</span><span class="o">/</span><span class="n">iocs</span><span class="p">:</span><span class="n">bl01t</span><span class="o">/</span><span class="n">bl01t</span><span class="o">-</span><span class="n">ea</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">02</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">st</span><span class="o">.</span><span class="n">cmd</span>
<span class="n">mot</span><span class="o">-</span><span class="n">script</span><span class="o">-</span><span class="n">boot</span>
<span class="n">dla</span><span class="o">=</span><span class="n">malloc</span> <span class="mh">0x230000</span>
<span class="n">tftpGet</span> <span class="o">-</span><span class="n">d</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">enet1</span> <span class="o">-</span><span class="n">fbl01t</span><span class="o">/</span><span class="n">bl01t</span><span class="o">-</span><span class="n">ea</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="mi">02</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">RTEMS</span><span class="o">-</span><span class="n">beatnik</span><span class="o">/</span><span class="n">ioc</span><span class="o">.</span><span class="n">boot</span> <span class="o">-</span><span class="n">m255</span><span class="mf">.255.240.0</span> <span class="o">-</span><span class="n">g172</span><span class="mf">.23.240.254</span> <span class="o">-</span><span class="n">s172</span><span class="mf">.23.168.203</span> <span class="o">-</span><span class="n">c172</span><span class="mf">.23.250.15</span> <span class="o">-</span><span class="n">adla</span>
<span class="n">go</span> <span class="o">-</span><span class="n">a0095F000</span>

<span class="n">Total</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">GE</span> <span class="n">Variables</span> <span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">Bytes</span> <span class="n">Utilized</span> <span class="o">=</span><span class="mi">427</span><span class="p">,</span> <span class="n">Bytes</span> <span class="n">Free</span> <span class="o">=</span><span class="mi">3165</span>
</pre></div>
</div>
<p>Now use <code class="docutils literal notranslate"><span class="pre">gevEdit</span></code> to change the global variables to the values you need.
For this tutorial we will create an IOC called bl01t-ea-test-02 and for the
example we assume the file server is on 172.23.168.203. For the details of
setting up these parameters see your site documentation but the important
values to change for this tutorial IOC would be:</p>
<dl class="field-list simple">
<dt class="field-odd">rtems-client-name<span class="colon">:</span></dt>
<dd class="field-odd"><p>bl01t-ea-test-02</p>
</dd>
<dt class="field-even">epics-script<span class="colon">:</span></dt>
<dd class="field-even"><p>172.23.168.203:/iocs:bl01t/bl01t-ea-test-02/config/st.cmd</p>
</dd>
<dt class="field-odd">mot-script-boot (2nd line)<span class="colon">:</span></dt>
<dd class="field-odd"><p>tftpGet -d/dev/enet1 -fbl01t/bl01t-ea-test-02/bin/RTEMS-beatnik/ioc.boot -m255.255.240.0 -g172.23.240.254 -s172.23.168.203 -c172.23.250.15 -adla</p>
</dd>
</dl>
<p>Now your <code class="docutils literal notranslate"><span class="pre">gevShow</span></code> should look similar to the example above.</p>
<p>Meaning of the parameters:</p>
<dl class="field-list simple">
<dt class="field-odd">rtems-client-name<span class="colon">:</span></dt>
<dd class="field-odd"><p>a name for the IOC crate</p>
</dd>
<dt class="field-even">epics-script<span class="colon">:</span></dt>
<dd class="field-even"><p>an NFS address for the IOC’s root folder</p>
</dd>
<dt class="field-odd">mot-script-boot<span class="colon">:</span></dt>
<dd class="field-odd"><p>a TFTP address for the IOC’s binary boot file</p>
</dd>
</dl>
<p>Note that the IP parameters to the tftpGet command are respectively:
net mask, gateway, server address, client address.</p>
</section>
<section id="creating-an-rtems-ioc-instance">
<h2>Creating an RTEMS IOC Instance<a class="headerlink" href="#creating-an-rtems-ioc-instance" title="Link to this heading">#</a></h2>
<p>We will be adding a new IOC instance to the <code class="docutils literal notranslate"><span class="pre">bl01t</span></code> beamline that we created in
<a class="reference internal" href="create_beamline.html"><span class="doc">Create a Beamline Repository</span></a>. The first step is to make a copy of our existing IOC instance
and make some modifications to it. We will call this new IOC instance
<code class="docutils literal notranslate"><span class="pre">bl01t-ea-test-02</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>bl01t
cp<span class="w"> </span>-r<span class="w"> </span>services/bl01t-ea-test-01<span class="w"> </span>services/bl01t-ea-test-02
<span class="c1"># don&#39;t need this file for the new IOC</span>
rm<span class="w"> </span>services/bl01t-ea-test-02/config/extra.db
</pre></div>
</div>
<p>We are going to make a very basic IOC with some hand coded database with
a couple of simple records. Therefore the Generic IOC that we use can just
be ioc-template.</p>
<p>Generic IOCs have multiple targets, they always have a
<code class="docutils literal notranslate"><span class="pre">developer</span></code> target which is used for building and debugging the Generic IOC and
a <code class="docutils literal notranslate"><span class="pre">runtime</span></code> target which is lightweight and usually used when running the IOC
in the cluster. The matrix of targets also includes an architecture dimension,
at present the ioc-template supports two architectures, <code class="docutils literal notranslate"><span class="pre">linux</span></code> and
<code class="docutils literal notranslate"><span class="pre">rtems</span></code>, thus there are 4 targets in total as follows:</p>
<ul class="simple">
<li><p>ghcr.io/epics-containers/ioc-templateruntime</p></li>
<li><p>ghcr.io/epics-containers/ioc-templatedeveloper</p></li>
<li><p>ghcr.io/epics-containers/ioc-template-rtems-runtime</p></li>
<li><p>ghcr.io/epics-containers/ioc-template-rtems-developer</p></li>
</ul>
<p>We want to run the RTEMS runtime target on the cluster so this will appear
at the top of the <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file. In addition there are a number of
environment variables required for the RTEMS target that we also specify in
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>.
Edit the file
<code class="docutils literal notranslate"><span class="pre">services/bl01t-ea-test-02/values.yaml</span></code> to look like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">base_image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/epics-containers/ioc-template-rtems-runtime:23.4.2</span>

<span class="nt">env</span><span class="p">:</span>
<span class="c1"># This is used to set EPICS_IOC_ADDR_LIST in the liveness probe client</span>
<span class="c1"># It is only needed if auto addr list discovery would fail</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K8S_IOC_ADDRESS</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.23.250.15</span>

<span class="c1"># RTEMS console connection details</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RTEMS_VME_CONSOLE_ADDR</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ts0001.cs.diamond.ac.uk</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RTEMS_VME_CONSOLE_PORT</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;7007&quot;</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RTEMS_VME_AUTO_REBOOT</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RTEMS_VME_AUTO_PAUSE</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>If you are not at DLS you will need to change the above to match the
parameters of your RTEMS Crate. The environment variables are:</p>
<table class="table" id="id1">
<caption><span class="caption-text">RTEMS Environment Variables</span><a class="headerlink" href="#id1" title="Link to this table">#</a></caption>
<colgroup>
<col style="width: 30.0%" />
<col style="width: 70.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>K8S_IOC_ADDRESS</p></td>
<td><p>The IP address of the IOC (mot-/dev/enet0-cipa above)</p></td>
</tr>
<tr class="row-odd"><td><p>RTEMS_VME_CONSOLE_ADDR</p></td>
<td><p>Address of terminal server for console access</p></td>
</tr>
<tr class="row-even"><td><p>RTEMS_VME_CONSOLE_PORT</p></td>
<td><p>Port of terminal server for console access</p></td>
</tr>
<tr class="row-odd"><td><p>RTEMS_VME_AUTO_REBOOT</p></td>
<td><p>true to reboot the hard IOC when the IOC container changes</p></td>
</tr>
<tr class="row-even"><td><p>RTEMS_VME_AUTO_PAUSE</p></td>
<td><p>true to pause/unpause when the IOC container stops/starts</p></td>
</tr>
</tbody>
</table>
<p>Edit the file <code class="docutils literal notranslate"><span class="pre">services/bl01t-ea-test-02/Chart.yaml</span></code> and change the 1st 4 lines
to represent this new IOC (the rest of the file is boilerplate):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bl01t-ea-test-02</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">example RTEMS IOC for bl01t</span>
</pre></div>
</div>
<p>For configuration we will create a simple database with a few of records and
a basic startup script. Add the following files to the
<code class="docutils literal notranslate"><span class="pre">services/bl01t-ea-test-02/config</span></code> directory.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">bl01t-ea-test-02.db</span><a class="headerlink" href="#id2" title="Link to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">record</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="s2">&quot;bl01t-ea-test-02:SUM&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">field</span><span class="p">(</span><span class="n">DESC</span><span class="p">,</span> <span class="s2">&quot;Sum A and B&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">CALC</span><span class="p">,</span> <span class="s2">&quot;A+B&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">SCAN</span><span class="p">,</span> <span class="s2">&quot;.1 second&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">INPA</span><span class="p">,</span> <span class="s2">&quot;bl01t-ea-test-02:A&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">INPB</span><span class="p">,</span> <span class="s2">&quot;bl01t-ea-test-02:B&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">record</span><span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="s2">&quot;bl01t-ea-test-02:A&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">field</span><span class="p">(</span><span class="n">DESC</span><span class="p">,</span> <span class="s2">&quot;A voltage&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">EGU</span><span class="p">,</span>  <span class="s2">&quot;Volts&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">VAL</span><span class="p">,</span>  <span class="s2">&quot;0.0&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">record</span><span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="s2">&quot;bl01t-ea-test-02:B&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">field</span><span class="p">(</span><span class="n">DESC</span><span class="p">,</span> <span class="s2">&quot;B voltage&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">EGU</span><span class="p">,</span>  <span class="s2">&quot;Volts&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">VAL</span><span class="p">,</span>  <span class="s2">&quot;0.0&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">st.cmd</span><a class="headerlink" href="#id3" title="Link to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># RTEMS Test IOC bl01t-ea-test-02</span>

<span class="n">dbLoadDatabase</span> <span class="s2">&quot;/services/bl01t/bl01t-ea-test-02/dbd/ioc.dbd&quot;</span>
<span class="n">ioc_registerRecordDeviceDriver</span><span class="p">(</span><span class="n">pdbbase</span><span class="p">)</span>

<span class="c1"># db files from the support modules are all held in this folder</span>
<span class="n">epicsEnvSet</span><span class="p">(</span><span class="n">EPICS_DB_INCLUDE_PATH</span><span class="p">,</span> <span class="s2">&quot;/services/bl01t/bl01t-ea-test-02/support/db&quot;</span><span class="p">)</span>

<span class="c1"># load our hand crafted database</span>
<span class="n">dbLoadRecords</span><span class="p">(</span><span class="s2">&quot;/services/bl01t/bl01t-ea-test-02/config/bl01t-ea-test-02.db&quot;</span><span class="p">)</span>
<span class="c1"># also make Database records for DEVIOCSTATS</span>
<span class="n">dbLoadRecords</span><span class="p">(</span><span class="n">iocAdminSoft</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;IOC=bl01t-ea-test-02&quot;</span><span class="p">)</span>
<span class="n">dbLoadRecords</span><span class="p">(</span><span class="n">iocAdminScanMon</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;IOC=bl01t-ea-test-02&quot;</span><span class="p">)</span>

<span class="n">iocInit</span>
</pre></div>
</div>
</div>
<p>You now have a new helm chart in services/bl01t-ea-test-02 that describes an IOC
instance for your RTEMS device. Recall that this is not literally where the IOC
runs, it deploys a kubernetes pod that manages the RTEMS IOC. It does contain
the IOC’s configuration and the IOC’s binary code, which it will copy to the
file-server on startup.</p>
<p>Finally you will need to tell the IOC to mount the Persistent Volume Claim
that the bl01t-ioc-files service is serving over NFS and TFTP. To do this
add the following lines to <code class="docutils literal notranslate"><span class="pre">services/bl01t-ea-test-02/values.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># for RTEMS IOCS this is the PVC name for the filesystem where RTEMS</span>
<span class="c1"># IOCs look for their files - enable this in RTEMS IOCs only</span>
<span class="nt">nfsv2TftpClaim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bl01t-ioc-files-claim</span>
</pre></div>
</div>
<p>You are now ready to deploy the IOC instance to the cluster and test it out.</p>
</section>
<section id="deploying-an-rtems-ioc-instance">
<h2>Deploying an RTEMS IOC Instance<a class="headerlink" href="#deploying-an-rtems-ioc-instance" title="Link to this heading">#</a></h2>
<p>To deploy an IOC instance to the cluster you can use one of two approaches:</p>
<ul class="simple">
<li><p>push your beamline repo to GitHub and tag it. Then use <code class="docutils literal notranslate"><span class="pre">ec</span> <span class="pre">deploy</span></code> to
deploy the resulting versioned IOC instance. This was covered for linux IOCs
in <a class="reference internal" href="deploy_example.html"><span class="doc">Deploying and Managing IOC Instances</span></a>.</p></li>
<li><p>use <code class="docutils literal notranslate"><span class="pre">ec</span> <span class="pre">deploy-local</span></code> to directly deploy the local copy of the IOC
instance helm chart to kubernetes as a beta version. This was covered for
linux IOCs in –local_deploy_ioc–.</p></li>
</ul>
<p>Both types of deployment of IOC instances above work exactly the same for
linux and RTEMS IOCs. We will do the latter as it is quicker for
the purposes of the tutorial.</p>
<p>Execute the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>bl01t
ec<span class="w"> </span>deploy-local<span class="w"> </span>services/bl01t-ea-test-02
</pre></div>
</div>
<p>When an RTEMS Kubernetes pod runs up it will make a telnet connection to
the hard IOC’s console and present the console as stdin/stdout of the
container. This means once you have done the above deployment the command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ec<span class="w"> </span>logs<span class="w"> </span>bl01t-ea-test-02<span class="w"> </span>-f
</pre></div>
</div>
<p>will show the RTEMS console output, and follow it along (<code class="docutils literal notranslate"><span class="pre">-f</span></code>) as the IOC
starts up. You can hit <code class="docutils literal notranslate"><span class="pre">^C</span></code> to stop following the logs.</p>
<p>You can also attach to the container and interact with the RTEMS console via
the telnet connection with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ec<span class="w"> </span>attach<span class="w"> </span>bl01t-ea-test-02
</pre></div>
</div>
<p>Most likely for the first deploy your IOC will still be sitting at the
<code class="docutils literal notranslate"><span class="pre">MVME5500&gt;</span></code> prompt. If you see this prompt when you attach then you need
to type <code class="docutils literal notranslate"><span class="pre">reset</span></code> to restart the boot-loader. This should then go through
the boot-loader startup and eventually start the IOC.</p>
</section>
<section id="checking-your-rtems-ioc">
<h2>Checking your RTEMS IOC<a class="headerlink" href="#checking-your-rtems-ioc" title="Link to this heading">#</a></h2>
<p>To verify that your RTEMS IOC is working you should be able to execute the
following commands and get correct sum of the A and B values:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>caput<span class="w"> </span>bl01t-ea-test-02:A<span class="w"> </span><span class="m">12</span>
caput<span class="w"> </span>get<span class="w"> </span>bl01t-ea-test-02:B<span class="w"> </span><span class="m">13</span>
caget<span class="w"> </span>get<span class="w"> </span>bl01t-ea-test-02:SUM
</pre></div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="rtems_setup.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">RTEMS - Creating a File Server</p>
      </div>
    </a>
    <a class="right-next"
       href="../how-to.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">How-to Guides</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-rtems-boot-loader">Preparing the RTEMS Boot loader</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-an-rtems-ioc-instance">Creating an RTEMS IOC Instance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deploying-an-rtems-ioc-instance">Deploying an RTEMS IOC Instance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-your-rtems-ioc">Checking your RTEMS IOC</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/epics-containers/epics-containers.github.io/edit/main/docs/tutorials/rtems_ioc.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/tutorials/rtems_ioc.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>