<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Useful Kubernetes Additions &mdash; epics_containers 0.6+4.g6feb4f5 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/k8s-epics2.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Create a beamline repository" href="create_beamline.html" />
    <link rel="prev" title="Setup a Kubernetes Server" href="setup_k8s.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: rgb(7, 43, 93)" >
            <a href="../index.html" class="icon icon-home"> epics_containers
            <img src="../_static/k8s-epics2.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                main
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup_k8s.html">Setup a Kubernetes Server</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Useful Kubernetes Additions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#install-the-kubernetes-dashboard">Install the Kubernetes Dashboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installing-on-a-raspberry-pi">Installing on a Raspberry Pi</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installing-on-windows-subsystem-for-linux">Installing on Windows Subsystem for Linux</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#install-k3s-server">Install k3s server</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-x11-gui-to-work-with-wsl">Get X11 GUI to Work with WSL</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="create_beamline.html">Create a beamline repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy_example.html">Deploy The Example IOC</a></li>
<li class="toctree-l1"><a class="reference internal" href="manage_iocs.html">Manage IOCs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/introduction.html">Essential Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/whats_in.html">epics-containers Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/net_protocols.html">Channel Access and Other Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/kubernetes_cluster.html">Kubernetes Cluster Config</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/add_ioc.html">Add an IOC instance to a beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/create_ioc.html">Create a new generic IOC image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/run_iocs.html">Run an IOC without Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/debug.html">Debug an IOC instance locally</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/debug.html#debug-an-ioc-instance-in-kubernetes">Debug an IOC instance in Kubernetes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/cli.html">Command Line Interface for IOC Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/contributing.html">Contributing</a></li>
</ul>

  <!-- Add versions for selected branches + tags -->
  <p class="caption">
    <span class="caption-text">Versions</span>
  </p>
  <ul id="versions"/>
  <script>
    // Add any branches to appear in the side pane here, tags will be added below
    // Will only appear if docs are built and pushed in gh-pages
    var versions = ['main', 'master'];
    var dirs = new Set();
    function addVersion(name) {
      if (dirs.has(name)) {
        var li = document.createElement("li");
        var a = document.createElement("a");
        a.href = 'https://epics-containers.github.io/epics_containers/' + name;
        a.innerText = name;
        li.appendChild(a)
        document.getElementById('versions').appendChild(li);
      }
    }
    Promise.all([
      // Find gh-pages directories and populate `dirs`
      fetch("https://api.github.com/repos/epics-containers/epics_containers/contents?ref=gh-pages")
      .then(response => response.json())
      .then(data => data.forEach(function(e) {
        if (e.type == "dir") dirs.add(e.name);
      })),
      // Add tags to `versions`
      fetch('https://api.github.com/repos/epics-containers/epics_containers/tags')
        .then(response => response.json())
        .then(data => data.forEach(function(e) {
          versions.push(e.name);
        }))
      ]).then(_ => versions.forEach(addVersion))
  </script>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: rgb(7, 43, 93)" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">epics_containers</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Useful Kubernetes Additions</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/useful_k8s.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="useful-kubernetes-additions">
<h1>Useful Kubernetes Additions<a class="headerlink" href="#useful-kubernetes-additions" title="Permalink to this headline"></a></h1>
<p>For the quickest path through the tutorial use an x86 linux machine
and follow the instructions here <a class="reference internal" href="setup_k8s.html#setup-kubernetes"><span class="std std-ref">Setup a Kubernetes Server</span></a>. For additional
options and non-essential features use this page.</p>
<section id="install-the-kubernetes-dashboard">
<h2>Install the Kubernetes Dashboard<a class="headerlink" href="#install-the-kubernetes-dashboard" title="Permalink to this headline"></a></h2>
<p>The dashboard gives you a nice GUI for exploring and controlling your cluster.
It is very useful for new users to get an understanding of what Kubernetes
has to offer.</p>
<p>Execute this on your workstation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">GITHUB_URL</span><span class="o">=</span>https://github.com/kubernetes/dashboard/releases
<span class="nv">VERSION_KUBE_DASHBOARD</span><span class="o">=</span><span class="k">$(</span>curl -w <span class="s1">&#39;%{url_effective}&#39;</span> -I -L -s -S <span class="si">${</span><span class="nv">GITHUB_URL</span><span class="si">}</span>/latest -o /dev/null <span class="p">|</span> sed -e <span class="s1">&#39;s|.*/||&#39;</span><span class="k">)</span>
kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/<span class="si">${</span><span class="nv">VERSION_KUBE_DASHBOARD</span><span class="si">}</span>/aio/deploy/recommended.yaml
</pre></div>
</div>
<p>Then create the admin user and role by executing the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl apply -f - <span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: ServiceAccount</span>
<span class="s">metadata:</span>
<span class="s">  name: admin-user</span>
<span class="s">  namespace: kubernetes-dashboard</span>
<span class="s">---</span>
<span class="s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="s">kind: ClusterRoleBinding</span>
<span class="s">metadata:</span>
<span class="s">  name: admin-user</span>
<span class="s">roleRef:</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">  kind: ClusterRole</span>
<span class="s">  name: cluster-admin</span>
<span class="s">subjects:</span>
<span class="s">- kind: ServiceAccount</span>
<span class="s">  name: admin-user</span>
<span class="s">  namespace: kubernetes-dashboard</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>get a token for the user and copy the token into your clipboard:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span> <span class="n">describe</span> <span class="n">secret</span> <span class="n">admin</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">token</span> <span class="o">|</span> <span class="n">grep</span> <span class="s1">&#39;^token&#39;</span>
</pre></div>
</div>
<p>Use kubectl to start a proxy that will forward HTTP requests to your cluster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">proxy</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>Finally, browse to <a class="reference external" href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/workloads?namespace=epics-iocs">Dashboard Screen URL</a> and paste the Token that you copied above:</p>
</section>
<section id="installing-on-a-raspberry-pi">
<span id="raspberry"></span><h2>Installing on a Raspberry Pi<a class="headerlink" href="#installing-on-a-raspberry-pi" title="Permalink to this headline"></a></h2>
<p>Raspberry Pi3 and Pi4 can run the k3s server. The more memory installed the
better.</p>
<p>We have not worked out how to run the client tools kubectl and helm on the Pi
as yet. You can run these on a separate linux or Windows workstation. There
are arm64 versions of helm and kubectl so we expect that the
<a class="reference external" href="https://www.raspberrypi.org/forums/viewtopic.php?t=275370">64bit Raspberry Pi OS</a> would be able to run these, but this is untested.</p>
<p>For a Raspberry Pi you need a couple of extra settings to get K3S running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="nb">set</span> <span class="n">iptables</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">legacy</span>
<span class="c1"># edit /boot/cmdline and make sure the single line contains:</span>
<span class="c1">#  cgroup_memory=1 cgroup_enable=memory</span>
<span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
</section>
<section id="installing-on-windows-subsystem-for-linux">
<span id="wsl"></span><h2>Installing on Windows Subsystem for Linux<a class="headerlink" href="#installing-on-windows-subsystem-for-linux" title="Permalink to this headline"></a></h2>
<p>WSL2 gives you a linux distribution running within Windows, the following
additional instructions explain how to use this platform.</p>
<section id="install-k3s-server">
<h3>Install k3s server<a class="headerlink" href="#install-k3s-server" title="Permalink to this headline"></a></h3>
<p>First you need Windows 10 OS build 20262 or higher.
Then follow the <a class="reference external" href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">WSL2 instructions</a>.
When installing the linux distribution, choose Ubuntu.</p>
<p>Start a new WSL2 Window and bring up the k3s server as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">k3s</span><span class="o">-</span><span class="n">io</span><span class="o">/</span><span class="n">k3s</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">v1</span><span class="mf">.21.2</span><span class="o">%</span><span class="mi">2</span><span class="n">Bk3s1</span><span class="o">/</span><span class="n">k3s</span>
<span class="n">sudo</span> <span class="n">install</span> <span class="o">-</span><span class="n">o</span> <span class="n">root</span> <span class="o">-</span><span class="n">g</span> <span class="n">root</span> <span class="o">-</span><span class="n">m</span> <span class="mi">0755</span> <span class="n">k3s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">k3s</span>
<span class="n">sudo</span> <span class="n">k3s</span> <span class="n">server</span>
</pre></div>
</div>
<p>There are no services in WSL so this k3s server will run in the foreground.
You need to start a second WLS window to continue as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">.</span><span class="n">kube</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rancher</span><span class="o">/</span><span class="n">k3s</span><span class="o">/</span><span class="n">k3s</span><span class="o">.</span><span class="n">yaml</span> <span class="o">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="n">giles</span> <span class="o">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
</pre></div>
</div>
<p>At this point you can return to the main instructions at <a class="reference internal" href="setup_k8s.html#install-kubectl"><span class="std std-ref">Install kubectl</span></a>.</p>
</section>
<section id="get-x11-gui-to-work-with-wsl">
<h3>Get X11 GUI to Work with WSL<a class="headerlink" href="#get-x11-gui-to-work-with-wsl" title="Permalink to this headline"></a></h3>
<p>When you come to launch the GUI later on you will need some additional steps
as follows.</p>
<p>First you will need install <a class="reference external" href="https://docs.docker.com/docker-for-windows/wsl/">docker for WSL</a>.</p>
<p>You will also require an <a class="reference external" href="https://sourceforge.net/projects/vcxsrv/">X11 Server for Windows</a>. When you run the server
choose the option <strong>Disable Access Control</strong> as follows:</p>
<img alt="../_images/vcxsrv.png" class="align-center" src="../_images/vcxsrv.png" />
<p>The networking for docker on WSL will not broadcast between containers so
you need to use EPICS_CA_ADDR_LIST to get edm to see the example IOC
PVs. To do this perform the following steps to get the name of the
example IOC pod and discover its IP address, then pass that to the
edm container:</p>
<p>cd to the root of the project you created in <a class="reference internal" href="deploy_example.html"><span class="doc">Deploy The Example IOC</span></a>, then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl get pods
    NAME                      READY   STATUS    RESTARTS   AGE
    example-6779d4dcf-g2cpm   1/1     Running   2          19h

kubectl exec -it example-6779d4dcf-g2cpm -- busybox ifconfig eth0
    eth0      Link encap:Ethernet  HWaddr 70:85:C2:DB:70:96
              inet addr:192.168.86.33  Bcast:192.168.86.255  Mask:255.255.255.0

export DISPLAY=$(awk &#39;/nameserver / {print $2; exit}&#39; /etc/resolv.conf 2&gt;/dev/null):0
export LIBGL_ALWAYS_INDIRECT=1

# IP ADDRESS from above kubectl command
./opi/stexample-gui.sh -e EPICS_CA_ADDR_LIST=192.168.86.33
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="setup_k8s.html" class="btn btn-neutral float-left" title="Setup a Kubernetes Server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="create_beamline.html" class="btn btn-neutral float-right" title="Create a beamline repository" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Diamond Light Source.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>